import{eR as de,eS as ue,eT as me,eU as fe,eV as V,eW as pe,eX as ge,d6 as Se,d7 as he,d5 as xe,eY as Ie,d9 as I,dn as Z,eZ as we,d4 as a,e_ as H,e$ as K,f0 as X,f1 as Te,f2 as q,di as Ae,f3 as ve,df as J,db as Q,f4 as je,f5 as ye,f6 as ee,f7 as R,f8 as te,f9 as ne,fa as Ee,fb as b}from"./index-3CuyeEXd.js";import{F as Ce}from"./CheckCircleIcon-BVwJujcP.js";import{n as Fe}from"./Button-BCV6mjvS-BmN5ircB.js";import{r as Le,a as $e,l as be,t as Ue}from"./Layouts-Bmf8DxNP-CI3o64MK.js";import{s as O}from"./ModalHeader-BTru6YQw-Cho8yYGx.js";import{r as ae}from"./ScreenHeader-Biz1wq02-DrCTkS1r.js";import{t as M}from"./FundWalletMethodHeader-CS84Ots9-CY2hZanT.js";import{i as We}from"./InjectedWalletIcon-DLcYOGDj-FWZxtEp1.js";import{t as De}from"./index-CJMgUOnw-DFxtpEnK.js";import{e as ke,o as Re,r as Oe,i as Me}from"./Value-B4M62ove-BgFNWV75.js";import{c as Pe}from"./useGetTokenPrice-CDPxMEO--MeHz7_8v.js";import{t as Ne}from"./analytics-mkkvFRju-DOXuftJB.js";import{C as F,e as re,s as Be}from"./getFormattedUsdFromLamports-B6EqSEho-C-HCdwKa.js";import{r as _e}from"./getUsdcMintAddress-DFI1hv05-jlhpBW9a.js";import{e as Ye}from"./getChainName-DjpPdUSc-c2urPd0g.js";import{n as P}from"./formatters-EiDssw70.js";import"./WalletIcon-BILrcMYS.js";import"./LoadingSkeleton-CHdaq3pb-CFR7ZnUF.js";import"./useGetSolPrice-Cfm8o9C5-Cxl-ykrp.js";var ze="11111111111111111111111111111111";function Ge(e){if(!e)throw new Error("Expected a Address.");return typeof e=="object"&&"address"in e?e.address:Array.isArray(e)?e[0]:e}function Ve(e,s){return r=>{if(!r.value)return;const i=r.isWritable?V.WRITABLE:V.READONLY;return Object.freeze({address:Ge(r.value),role:se(r.value)?pe(i):i,...se(r.value)?{signer:r.value}:{}})}}function se(e){return!!e&&typeof e=="object"&&"address"in e&&ge(e)}var Ze=2;function He(){return de(ue([["discriminator",me()],["amount",fe()]]),e=>({...e,discriminator:Ze}))}function Ke(e,s){const r=ze,o={source:{value:e.source??null,isWritable:!0},destination:{value:e.destination??null,isWritable:!0}},l={...e},c=Ve();return Object.freeze({accounts:[c(o.source),c(o.destination)],data:He().encode(l),programAddress:r})}function Xe({rows:e}){return a.jsx(ke,{children:e.filter((s=>!!s)).map(((s,r)=>s.value!=null||s.isLoading?a.jsxs(Re,{children:[a.jsx(Oe,{children:s.label}),a.jsx(Me,{$isLoading:s.isLoading,children:s.value})]},r):null))})}function B(e){return BigInt(Math.floor(1e9*parseFloat(e)))}function N(e){return+qe.format(parseFloat(e.toString())/1e9)}let qe=Intl.NumberFormat(void 0,{maximumFractionDigits:8});async function Je({tx:e,solanaClient:s,amount:r,asset:i,tokenPrice:o}){if(!e)return null;if(i==="SOL"&&o){let l=B(r),c=F(l,o),n=await b({solanaClient:s,tx:e});return{amountInUsd:c,feeInUsd:o?F(n,o):void 0,totalInUsd:F(l+n,o)}}if(i==="USDC"&&o){let l="$"+r,c=await b({solanaClient:s,tx:e}),n=(function(S,w){let L=parseFloat(S.toString())/Be*w;return L<.01?0:L})(c,o);return{amountInUsd:l,feeInUsd:F(c,o),totalInUsd:"$"+(parseFloat(r)+n).toFixed(2)}}if(i==="SOL"){let l=B(r),c=await b({solanaClient:s,tx:e});return{amountInSol:r+" SOL",feeInSol:N(c)+" SOL",totalInSol:N(l+c)+" SOL"}}return{amountInUsdc:r+" USDC",feeInSol:N(await b({solanaClient:s,tx:e}))+" SOL"}}const xt={component:function(){let e=Se(),{closePrivyModal:s,createAnalyticsEvent:r}=he(),{data:i,setModalData:o,navigate:l}=xe(),{wallets:c}=Ie(),[n,S]=I.useState("preparing"),[w,L]=I.useState(),[U,_]=I.useState(),[Y,W]=I.useState();if(!i?.solanaFundingData)throw Error("Funding config is missing");if(!i.solanaFundingData.sourceWalletData)throw Error("Funding config is missing source wallet data");let{amount:u,asset:g,chain:A,sourceWalletData:D,destinationAddress:j,afterSuccessScreen:z}=i.solanaFundingData,m=c.find((t=>t.address===D.address&&Z(D.walletClientType)===Z(t.standardWallet.name))),$=we()(A),{tokenPrice:y,isTokenPriceLoading:G}=Pe("solana");return I.useEffect((()=>{if(n!=="preparing"||G||!m)return;let t=g==="SOL"?B(u):(function(d){return BigInt(Math.floor(1e6*parseFloat(d)))})(u);_({amount:(g==="SOL"&&y?F(t,y):u)??u}),(g==="SOL"?(async function({solanaClient:d,source:h,destination:T,amountInLamports:E}){let{value:x}=await d.rpc.getLatestBlockhash().send(),v={address:h},C=H(q({version:0}),(f=>ne(v,f)),(f=>te(x,f)),(f=>R(Ke({amount:E,source:v,destination:T}),f)),(f=>ee(f)));return new Uint8Array(K().encode(C))})({solanaClient:$,source:m.address,destination:j,amountInLamports:t}):(async function({solanaClient:d,source:h,destination:T,amountInBaseUnits:E}){let x=_e(d.chain),{value:v}=await d.rpc.getLatestBlockhash().send(),C={address:h},[f]=await X({mint:x,owner:h,tokenProgram:re}),[k]=await X({mint:x,owner:T,tokenProgram:re}),[oe,ie]=await Promise.all([d.rpc.getAccountInfo(f,{commitment:"confirmed",encoding:"jsonParsed"}).send().catch((()=>null)),d.rpc.getAccountInfo(k,{commitment:"confirmed",encoding:"jsonParsed"}).send().catch((()=>null))]);if(!oe?.value)throw Error(`Source token account does not exist for address: ${h}`);let le=Te({payer:C,ata:k,owner:T,mint:x}),ce=H(q({version:0}),(p=>ne(C,p)),(p=>te(v,p)),(p=>ie?.value?p:R(le,p)),(p=>R(Ee({source:f,destination:k,authority:C,amount:E}),p)),(p=>ee(p)));return new Uint8Array(K().encode(ce))})({solanaClient:$,source:m.address,destination:j,amountInBaseUnits:t})).then(L).catch((d=>{S("error"),W(d)}))}),[n,u,g,A,m,j,G,y]),I.useEffect((()=>{n==="preparing"&&w&&Je({tx:w,solanaClient:$,amount:u,asset:g,tokenPrice:y}).then((t=>{S("loaded"),_({amount:t?.amountInUsd??t?.amountInUsdc??t?.amountInSol??u,fee:t?.feeInUsd??t?.feeInSol,total:t?.totalInUsd??t?.totalInSol})})).catch((t=>{S("error"),W(t)}))}),[w,u,g,n,y]),I.useEffect((()=>{n==="error"&&Y&&(o({errorModalData:{error:Y,previousScreen:"FundSolWalletWithExternalSolanaWallet"},solanaFundingData:i.solanaFundingData}),l("ErrorScreen",!1))}),[n,l]),I.useEffect((()=>{if(n!=="success")return;let t=setTimeout(z?()=>l(z):s,Ae);return()=>clearTimeout(t)}),[n]),a.jsxs(a.Fragment,n==="success"?{children:[a.jsx(M,{}),a.jsx(Le,{}),a.jsxs($e,{children:[a.jsx(Ce,{color:"var(--privy-color-success)",width:"64px",height:"64px"}),a.jsx(ae,{title:"Success!",description:`Youâ€™ve successfully added ${u} ${g} to your ${e.name} wallet. It may take a minute before the funds are available to use.`})]}),a.jsx(be,{}),a.jsx(O,{})]}:n==="preparing"||n==="loaded"||n==="sending"?{children:[a.jsx(M,{}),a.jsx(Ue,{style:{marginTop:"16px"},children:a.jsx(We,{icon:m?.standardWallet.icon,name:m?.standardWallet.name})}),a.jsx(ae,{style:{marginTop:"8px",marginBottom:"12px"},title:n==="sending"&&m?`Confirming with ${m.standardWallet.name}`:"Confirm transaction"}),a.jsx(Xe,{rows:[{label:"Source",value:P(D.address)},{label:"Destination",value:P(j)},{label:"Network",value:Ye(A)},{label:"Amount",value:U?.amount,isLoading:n==="preparing"},{label:"Estimated fee",value:U?.fee,isLoading:n==="preparing"},{label:"Total",value:U?.total,isLoading:n==="preparing"}]}),a.jsx(Fe,{style:{marginTop:"1rem"},loading:n==="preparing"||n==="sending",onClick:function(){n==="loaded"&&w&&m&&(S("sending"),(async function({transaction:t,chain:d,sourceWallet:h,solanaClient:T}){let{hasFunds:E}=await ve({solanaClient:T,tx:t});if(!E)throw new J(`Wallet ${P(h.address)} does not have enough funds.`,void 0,Q.INSUFFICIENT_BALANCE);let x=je((await h.signAndSendTransaction({transaction:t,chain:d}).catch((v=>{throw new J("Transaction was rejected by the user",v,Q.TRANSACTION_FAILURE)}))).signature);return await ye({rpcSubscriptions:T.rpcSubscriptions,signature:x,timeout:2e4}),x})({solanaClient:$,transaction:w,chain:A,sourceWallet:m}).then((t=>{S("success"),r({eventName:Ne,payload:{provider:"external",status:"success",txHash:t,address:m.address,value:u,chainType:"solana",clusterName:A,token:g,destinationAddress:j,destinationValue:u,destinationChainType:"solana",destinationClusterName:A,destinationToken:g}})})).catch((t=>{S("error"),W(t)})))},children:"Confirm"}),a.jsx(O,{})]}:{children:[a.jsx(M,{}),a.jsx(De,{}),a.jsx("div",{style:{marginTop:"1rem"}}),a.jsx(O,{})]})}};export{xt as FundSolWalletWithExternalSolanaWallet,xt as default};
