<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Launchpad - LAUNCHR Mission Control</title>
    <meta name="description" content="Launch meme tokens on Pump.fun. 1% of creator fees go to the LAUNCHR distribution pool.">
    <link rel="icon" href="/favicon.ico" type="image/jpeg">
    <link rel="shortcut icon" href="/favicon.ico" type="image/jpeg">
    <link rel="apple-touch-icon" href="/website/logo-icon.jpg">
    <link rel="manifest" href="/phantom/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Privy SDK for embedded wallet -->
    
    <!-- Solana Web3.js for transaction handling -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <!-- bs58 for Base58 encoding -->
    <script src="https://unpkg.com/bs58@5.0.0/dist/index.umd.js"></script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Background Layers */
            --bg-deep: #030303;
            --bg: #050508;
            --bg-elevated: #0A0A0F;
            --surface: #0E0E14;
            --surface-2: #14141C;
            --surface-3: #1A1A24;
            --surface-4: #22222E;

            /* Borders */
            --border: rgba(255, 215, 100, 0.1);
            --border-subtle: rgba(255, 255, 255, 0.04);
            --border-active: rgba(255, 215, 100, 0.25);
            --border-strong: rgba(255, 215, 100, 0.4);

            /* Text */
            --text: #F5F5F7;
            --text-secondary: #A0A0A8;
            --text-muted: #606068;
            --text-dim: #404048;

            /* Primary - Light Vibrant Gold */
            --gold: #FFD966;
            --gold-light: #FFE699;
            --gold-bright: #FFEB99;
            --gold-dark: #E6B800;
            --gold-dim: rgba(255, 217, 102, 0.15);
            --gold-glow: rgba(255, 217, 102, 0.08);

            /* Metallic Gold Gradients */
            --gold-metallic: linear-gradient(135deg, #FFE699 0%, #FFD966 25%, #E6B800 50%, #FFD966 75%, #FFE699 100%);
            --gold-shine: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);

            /* Secondary - Electric Cyan */
            --cyan: #00E5FF;
            --cyan-light: #80F0FF;
            --cyan-dim: rgba(0, 229, 255, 0.12);

            /* Accent - Hot Pink */
            --pink: #FF3D8E;
            --pink-light: #FF6BA8;
            --pink-dim: rgba(255, 61, 142, 0.12);

            /* Purple Accent */
            --purple: #A855F7;
            --purple-dim: rgba(168, 85, 247, 0.15);

            /* Semantic */
            --success: #4ADE80;
            --success-dim: rgba(74, 222, 128, 0.12);
            --warning: #FBBF24;
            --warning-dim: rgba(251, 191, 36, 0.12);
            --error: #F43F5E;
            --error-dim: rgba(244, 63, 94, 0.12);

            /* Rank Colors - Metallic */
            --rank-gold: linear-gradient(135deg, #FFE699 0%, #FFD966 30%, #CC9900 60%, #FFD966 100%);
            --rank-silver: linear-gradient(135deg, #E8E8E8 0%, #B8B8B8 50%, #E8E8E8 100%);
            --rank-bronze: linear-gradient(135deg, #DDA15E 0%, #BC6C25 50%, #DDA15E 100%);

            /* Spacing & Radius */
            --radius-sm: 6px;
            --radius: 10px;
            --radius-lg: 14px;
            --radius-xl: 20px;
        }

        /* Shimmer Animation */
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 217, 102, 0.3), 0 0 40px rgba(255, 217, 102, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 217, 102, 0.5), 0 0 60px rgba(255, 217, 102, 0.2); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes tek-glow {
            0%, 100% {
                filter: drop-shadow(0 0 2px rgba(255, 217, 102, 0.6));
                opacity: 0.9;
            }
            50% {
                filter: drop-shadow(0 0 6px rgba(255, 217, 102, 0.9)) drop-shadow(0 0 10px rgba(255, 200, 100, 0.4));
                opacity: 1;
            }
        }

        .tek-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 6px;
            color: var(--gold);
            animation: tek-glow 3s ease-in-out infinite;
            cursor: help;
            vertical-align: middle;
        }
        .tek-icon svg {
            width: 14px;
            height: 14px;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        /* Editorial serif font for culture names and featured headings */
        .culture-name, .section-title, .page-title, h1 {
            font-family: 'Playfair Display', Georgia, serif;
        }

        /* Ambient Background - Dynamic Multi-Color */
        .ambient {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 100% 60% at 50% -20%, rgba(255, 217, 102, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 100% 0%, rgba(0, 229, 255, 0.08) 0%, transparent 40%),
                radial-gradient(ellipse 50% 40% at 0% 100%, rgba(255, 61, 142, 0.06) 0%, transparent 40%),
                radial-gradient(ellipse 40% 30% at 80% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 40%);
            pointer-events: none;
            z-index: 0;
            animation: gradient-flow 15s ease infinite;
            background-size: 200% 200%;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           NAVIGATION
           ═══════════════════════════════════════════════════════════════════════ */
        .nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            background: rgba(5, 5, 5, 0.92);
            backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid var(--border);
        }
        .nav-inner {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text);
        }
        .nav-brand img {
            height: 32px;
            width: 32px;
            border-radius: var(--radius-sm);
        }
        .nav-brand-text {
            display: flex;
            flex-direction: column;
        }
        .nav-brand-name {
            font-weight: 700;
            font-size: 16px;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }
        .nav-brand-tag {
            font-size: 10px;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .nav-links {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .nav-link {
            padding: 8px 14px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--radius);
            transition: all 0.15s ease;
        }
        .nav-link:hover {
            color: var(--text);
            background: var(--surface);
        }
        .nav-link.active {
            color: var(--gold);
            background: var(--gold-dim);
        }
        .nav-link.leaderboard-link {
            background: linear-gradient(135deg, rgba(255,217,102,0.15), rgba(255,61,142,0.1));
            border: 1px solid rgba(255,217,102,0.3);
            color: var(--gold);
            font-weight: 600;
            animation: pulse-glow 2s ease-in-out infinite;
        }
        .nav-link.leaderboard-link:hover {
            background: linear-gradient(135deg, rgba(255,217,102,0.25), rgba(255,61,142,0.15));
            border-color: var(--gold);
            transform: scale(1.02);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255,217,102,0); }
            50% { box-shadow: 0 0 12px 2px rgba(255,217,102,0.3); }
        }
        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 8px;
        }
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FFE699 0%, #FFD966 30%, #E6B800 70%, #FFD966 100%);
            background-size: 200% 200%;
            color: #0A0A0F;
            font-weight: 700;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 235, 153, 0.5);
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            background-position: 100% 0;
            transform: translateY(-2px);
            box-shadow:
                0 4px 15px rgba(255, 217, 102, 0.4),
                0 0 30px rgba(255, 217, 102, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 217, 102, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, var(--surface-2) 0%, var(--surface-3) 100%);
            color: var(--text);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .btn-secondary::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--surface-3) 0%, var(--surface-4) 100%);
            border-color: var(--border-active);
        }
        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover {
            color: var(--text);
            background: var(--surface);
        }
        .btn-sm {
            padding: 7px 14px;
            font-size: 12px;
        }
        .btn-icon {
            padding: 8px;
            min-width: 36px;
        }
        .wallet-connected {
            background: var(--gold-dim) !important;
            color: var(--gold) !important;
            border-color: rgba(196, 165, 116, 0.3) !important;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           LAYOUT
           ═══════════════════════════════════════════════════════════════════════ */
        .main {
            padding-top: 64px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Page Header */
        .page-header {
            padding: 28px 32px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }
        .page-header-inner {
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        .page-header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        .page-title-group {}
        .page-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        .page-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .page-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Timer */
        .timer-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 22px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-2) 100%);
            border: 1px solid rgba(255, 217, 102, 0.2);
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(255, 217, 102, 0.1);
        }
        .timer-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }
        .timer-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255,217,102,0.2) 0%, rgba(255,217,102,0.1) 100%);
            border-radius: var(--radius);
            animation: float 3s ease-in-out infinite;
        }
        .timer-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--gold);
            filter: drop-shadow(0 0 5px rgba(255, 217, 102, 0.5));
        }
        .timer-content {}
        .timer-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .timer-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #FFE699, #FFD966, #FFCC00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.05em;
            text-shadow: 0 0 30px rgba(255, 217, 102, 0.5);
        }

        /* Stats Bar */
        .stats-bar {
            padding: 20px 32px;
            background: linear-gradient(180deg, var(--surface) 0%, var(--bg-elevated) 100%);
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .stats-bar::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg,
                var(--pink) 0%,
                var(--gold) 25%,
                var(--cyan) 50%,
                var(--purple) 75%,
                var(--pink) 100%
            );
            background-size: 200% 100%;
            animation: gradient-flow 4s linear infinite;
        }
        .stats-bar-inner {
            max-width: 1440px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            background: linear-gradient(90deg, rgba(255,217,102,0.15), rgba(0,229,255,0.1), rgba(255,61,142,0.1));
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow:
                0 0 30px rgba(255, 217, 102, 0.1),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }
        .stat-cell {
            padding: 18px 20px;
            background: linear-gradient(180deg, var(--surface) 0%, var(--bg-elevated) 100%);
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        .stat-cell:hover {
            background: linear-gradient(180deg, var(--surface-2) 0%, var(--surface) 100%);
        }
        .stat-cell:hover .stat-cell-value {
            transform: scale(1.05);
        }
        .stat-cell.clickable {
            cursor: pointer;
        }
        .stat-cell.clickable:hover {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(255, 217, 102, 0.2);
        }
        .stat-cell-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            transition: transform 0.3s ease;
            text-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .stat-cell-value.gold {
            background: linear-gradient(135deg, #FFE699, #FFD966, #FFCC00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255, 217, 102, 0.5));
        }
        .stat-cell-value.teal {
            color: var(--cyan);
            text-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        }
        .stat-cell-value.success {
            color: var(--success);
            text-shadow: 0 0 15px rgba(74, 222, 128, 0.5);
        }
        .stat-cell-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 6px;
        }

        /* Content Grid */
        .content {
            max-width: 1440px;
            margin: 0 auto;
            padding: 24px 32px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
        }
        .content-single {
            grid-template-columns: 1fr;
            max-width: 1400px;
        }
        .content-single .card {
            width: 100%;
        }
        .token-list {
            overflow-x: auto;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-secondary);
        }
        .card-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
        }
        .card-badge.live {
            color: var(--success);
        }
        .card-badge.live::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: livePulse 2s infinite;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        @keyframes scrollTrending {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .trending-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            border-top: 1px solid var(--border);
            padding: 12px 0;
            overflow: hidden;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            position: relative;
        }
        .trending-scroll-wrapper {
            display: flex;
            align-items: center;
            gap: 24px;
            animation: scrollTrending 30s linear infinite;
            width: max-content;
        }
        .trending-scroll-wrapper:hover {
            animation-play-state: paused;
        }
        .trending-label {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            padding-left: 24px;
        }
        .trending-label span:first-child {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .trending-badge {
            background: var(--gold);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        .trending-token {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--surface-2);
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .trending-token:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
        }
        .trending-token img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        .trending-token-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .trending-token-change {
            font-size: 11px;
            font-weight: 600;
        }
        .trending-token-change.positive {
            color: var(--success);
        }
        .trending-token-change.negative {
            color: var(--danger);
        }
        .card-body {
            padding: 16px 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 2px;
            padding: 3px;
            background: var(--bg-deep);
            border-radius: var(--radius);
        }
        .tab {
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab:hover {
            color: var(--text-secondary);
        }
        .tab.active {
            background: var(--surface-2);
            color: var(--gold);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           LEADERBOARD
           ═══════════════════════════════════════════════════════════════════════ */
        .leaderboard {}
        .leader-item {
            display: grid;
            grid-template-columns: 36px 1fr auto auto;
            gap: 14px;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.12s ease;
        }
        .leader-item:hover {
            background: var(--surface-2);
        }
        .leader-item:last-child {
            border-bottom: none;
        }
        .leader-rank {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 800;
            border-radius: var(--radius);
            background: var(--surface-3);
            color: var(--text-muted);
            position: relative;
            overflow: hidden;
        }
        .leader-rank.rank-1 {
            background: linear-gradient(135deg, #FFE699 0%, #FFD966 25%, #CC9900 50%, #FFD966 75%, #FFE699 100%);
            background-size: 200% 200%;
            color: #1a1a1a;
            box-shadow: 0 0 20px rgba(255, 217, 102, 0.4);
            animation: shimmer 3s linear infinite;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        .leader-rank.rank-1::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
            animation: shimmer 2s linear infinite;
        }
        .leader-rank.rank-2 {
            background: linear-gradient(135deg, #F0F0F0 0%, #C8C8C8 30%, #A0A0A0 50%, #C8C8C8 70%, #F0F0F0 100%);
            background-size: 200% 200%;
            color: #1a1a1a;
            box-shadow: 0 0 15px rgba(200, 200, 200, 0.3);
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        .leader-rank.rank-3 {
            background: linear-gradient(135deg, #DDA15E 0%, #BC6C25 40%, #8B4513 50%, #BC6C25 60%, #DDA15E 100%);
            background-size: 200% 200%;
            color: #1a1a1a;
            box-shadow: 0 0 15px rgba(188, 108, 37, 0.3);
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }
        .leader-info {
            min-width: 0;
        }
        .leader-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leader-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }
        .leader-ticker {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .leader-path {
            font-size: 10px;
            color: var(--teal);
            background: var(--teal-dim);
            padding: 2px 6px;
            border-radius: 3px;
        }
        .leader-mcap {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
            text-align: right;
        }
        .leader-reward {
            font-size: 11px;
            font-weight: 700;
            color: #1a1a1a;
            background: linear-gradient(135deg, #4ADE80 0%, #22C55E 50%, #4ADE80 100%);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            white-space: nowrap;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.4);
            animation: glow-pulse 2s ease-in-out infinite;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           TOKEN LIST
           ═══════════════════════════════════════════════════════════════════════ */
        .token-list {
            display: flex;
            flex-direction: column;
        }
        .token-item {
            display: grid;
            grid-template-columns: 52px 1fr auto auto;
            gap: 16px;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.12s ease;
        }
        .token-item:hover {
            background: var(--surface-2);
        }
        .token-item:last-child {
            border-bottom: none;
        }
        .token-avatar {
            width: 52px;
            height: 52px;
            border-radius: var(--radius);
            background: linear-gradient(135deg, var(--surface-3), var(--surface-4));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
            border: 1px solid var(--border);
        }
        .token-details {
            min-width: 0;
        }
        .token-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text);
            margin-bottom: 4px;
        }
        .token-meta {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .token-ticker {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
        }
        .token-path {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .token-path.pump {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }
        .token-path.launchr {
            background: var(--teal-dim);
            color: var(--teal);
        }
        .token-time {
            font-size: 11px;
            color: var(--text-muted);
        }
        .token-stats {
            text-align: right;
            min-width: 80px;
        }
        .token-mcap {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--gold);
        }
        .token-volume {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .token-change {
            min-width: 70px;
            text-align: right;
        }
        .token-change-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }
        .token-change-value.positive { color: var(--success); }
        .token-change-value.negative { color: var(--error); }
        .token-change-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           CREATE TOKEN FORM
           ═══════════════════════════════════════════════════════════════════════ */
        .create-section {
            margin-top: 16px;
        }
        .create-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .form-input {
            padding: 12px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.15s;
        }
        .form-input:hover {
            border-color: var(--border-active);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            background: var(--bg);
        }
        .form-input::placeholder {
            color: var(--text-dim);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-hint {
            padding: 14px 16px;
            background: var(--gold-dim);
            border: 1px solid rgba(196, 165, 116, 0.25);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-hint-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gold);
            color: var(--bg);
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
        }
        .image-upload:hover {
            border-color: var(--gold);
            background: var(--gold-dim);
        }
        .image-upload.icon-upload {
            min-height: 100px;
            aspect-ratio: 1;
        }
        .image-upload.banner-upload {
            min-height: 60px;
            aspect-ratio: 3/1;
        }
        .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 11px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .image-preview svg {
            opacity: 0.4;
        }
        .image-upload.has-image {
            border-style: solid;
            border-color: var(--success);
            background: var(--success-dim);
        }
        .image-upload.has-image .image-preview img {
            max-height: 70px;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 80px;
            border-radius: 6px;
            object-fit: cover;
        }
        .image-upload.has-image {
            border-style: solid;
            border-color: var(--teal);
            background: var(--teal-dim);
        }

        /* Social Links */
        .social-links-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .social-input {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .social-icon {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-right: none;
            border-radius: var(--radius) 0 0 var(--radius);
            font-size: 14px;
            color: var(--text-secondary);
        }
        .social-input .form-input {
            border-radius: 0 var(--radius) var(--radius) 0;
            font-size: 12px;
        }

        /* Dev Buy Slider */
        .dev-buy-input {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .dev-buy-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }
        .dev-buy-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .dev-buy-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        .dev-buy-value {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        .dev-buy-hint {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Path Toggle */
        .path-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .path-option {
            padding: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }
        .path-option:hover {
            border-color: var(--border-active);
        }
        .path-option.active {
            background: var(--gold-dim);
            border-color: var(--gold);
        }
        .path-option-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .path-option-name {
            font-weight: 600;
            font-size: 14px;
        }
        .path-option.active .path-option-name {
            color: var(--gold);
        }
        .path-option-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .path-option-badge.simple {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
        }
        .path-option-badge.advanced {
            background: var(--teal-dim);
            color: var(--teal);
        }
        .path-option-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           MODALS
           ═══════════════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            overflow-y: auto;
            padding: 40px 0;
        }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 420px;
            margin: 20px;
            flex-shrink: 0;
        }
        .modal-header {
            padding: 20px 24px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .modal-close:hover {
            background: var(--surface-3);
            color: var(--text);
        }
        .modal-body {
            padding: 24px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
        }
        .modal-actions .btn {
            flex: 1;
        }

        /* Wallet Modal */
        .wallet-info {
            text-align: center;
            padding: 20px 0;
        }
        .wallet-address {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            color: var(--text);
            background: var(--bg);
            padding: 14px 16px;
            border-radius: var(--radius);
            word-break: break-all;
            margin-bottom: 16px;
        }
        .wallet-balance {
            font-size: 32px;
            font-weight: 700;
            color: var(--gold);
        }
        .wallet-balance-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           FOOTER
           ═══════════════════════════════════════════════════════════════════════ */
        .footer {
            padding: 24px 32px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border);
            margin-top: 48px;
        }
        .footer-inner {
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .footer-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .footer-brand img {
            height: 22px;
            width: 22px;
            border-radius: 4px;
            opacity: 0.7;
        }
        .footer-brand span {
            color: var(--text-muted);
            font-size: 12px;
        }
        .footer-links {
            display: flex;
            gap: 20px;
        }
        .footer-links a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 12px;
            transition: color 0.15s;
        }
        .footer-links a:hover {
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════════════════════ */
        @media (max-width: 1200px) {
            .content { grid-template-columns: 1fr 340px; }
        }
        @media (max-width: 1024px) {
            .content { grid-template-columns: 1fr; }
            .content-single { max-width: 100%; }
            .nav-links { display: none; }
            .stats-bar-inner { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .page-header-inner { flex-direction: column; align-items: flex-start; }
            .stats-bar-inner { grid-template-columns: repeat(2, 1fr); }
            /* Modal mobile improvements */
            .modal-content {
                width: 95%;
                max-width: 100%;
                margin: 10px;
                max-height: 90vh;
            }
            .modal-body {
                padding: 16px;
            }
            .path-selector {
                flex-direction: column;
            }
            .path-option {
                width: 100%;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .trending-bar {
                padding: 8px 0;
            }
            .trending-scroll-wrapper {
                animation-duration: 20s;
            }
        }
        @media (max-width: 640px) {
            .nav-inner, .page-header, .stats-bar, .content, .footer { padding-left: 12px; padding-right: 12px; }
            .form-row { grid-template-columns: 1fr; }
            .footer-inner { flex-direction: column; gap: 16px; }
            .stats-bar-inner { grid-template-columns: 1fr 1fr; gap: 8px; }
            .stat-cell { padding: 12px 8px; }
            .stat-cell-value { font-size: 18px; }
            .stat-cell-label { font-size: 10px; }
            /* Modal tight mobile */
            .modal-content {
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                min-height: 100vh;
            }
            .modal-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: var(--surface);
            }
            .page-title { font-size: 22px; }
            .page-subtitle { font-size: 12px; }
            .card-header { padding: 12px 16px; }
            .btn-sm { padding: 8px 12px; font-size: 11px; }
        }
        @media (max-width: 480px) {
            .stats-bar-inner { grid-template-columns: 1fr; }
            .hero-actions { flex-direction: column; width: 100%; }
            .hero-actions .btn { width: 100%; }
        }

        /* Ensure Privy modal appears on top of everything */
        [id^="privy"], [class*="privy"], iframe[src*="privy"] {
            z-index: 99999 !important;
        }
        #privy-modal-content, #privy-dialog {
            z-index: 99999 !important;
        }

        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            margin: 0 auto;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Theme Toggle */
        .theme-toggle-btn {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .theme-toggle-btn:hover {
            border-color: var(--gold);
            background: var(--gold-dim);
        }
        .theme-toggle-btn svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }
        .theme-toggle-btn:hover svg { color: var(--gold); }
        .theme-icon-light { display: none; }
        body.light-mode .theme-icon-dark { display: none; }
        body.light-mode .theme-icon-light { display: block; }

        /* Light Mode */
        body.light-mode {
            --bg: #f5f7fa;
            --bg-elevated: #ffffff;
            --surface: #ffffff;
            --surface-2: #f0f2f5;
            --surface-3: #e4e6eb;
            --border: rgba(0, 0, 0, 0.08);
            --text: #2c3e50;
            --text-secondary: #546e7a;
            --text-muted: #90a4ae;
            --gold-dim: rgba(255, 193, 7, 0.12);
        }
        body.light-mode .nav {
            background: rgba(255, 255, 255, 0.98);
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }
        body.light-mode .card, body.light-mode .token-row {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.06);
        }
        body.light-mode .token-row:hover {
            background: #f8f9fa;
        }
        body.light-mode .modal {
            background: #ffffff;
        }
        body.light-mode .ambient {
            opacity: 0.2;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            background: #0a0a0a;
            border-right: 1px solid #1a1a1a;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
            font-family: 'IBM Plex Mono', monospace;
        }
        .sidebar-brand {
            padding: 0 16px 24px;
            border-bottom: 1px solid #1a1a1a;
            margin-bottom: 24px;
        }
        .sidebar-brand a {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #fff;
            font-weight: 600;
            font-size: 15px;
        }
        .sidebar-brand img {
            width: 28px;
            height: 28px;
            border-radius: 6px;
        }
        .sidebar-section {
            padding: 0 16px;
            margin-bottom: 24px;
        }
        .sidebar-label {
            font-size: 10px;
            color: #444;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: rgba(255, 217, 102, 0.6);
            font-size: 13px;
            font-family: 'IBM Plex Mono', monospace;
            cursor: pointer;
            text-align: left;
            text-decoration: none;
            margin-bottom: 4px;
            transition: all 0.2s;
        }
        .sidebar-link:hover {
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 217, 102, 0.3);
        }
        .sidebar-link.active {
            background: rgba(255, 217, 102, 0.1);
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 217, 102, 0.4);
        }
        .sidebar-link.disabled {
            color: rgba(255, 217, 102, 0.3);
            cursor: default;
            pointer-events: none;
        }
        .soon-tag {
            font-size: 10px;
            color: rgba(255, 217, 102, 0.4);
            margin-left: auto;
        }
        .sidebar-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }
        .sidebar-bottom {
            margin-top: auto;
            padding: 0 16px;
        }
        .main-content {
            margin-left: 200px;
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="ambient"></div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-brand">
            <a href="/">
                <img src="/website/logo-icon.jpg" alt="LAUNCHR">
                <span>LAUNCHR</span>
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">NAVIGATION</div>
            <a href="/" class="sidebar-link">
                <span class="sidebar-icon">⌂</span>
                Home
            </a>
            <a href="/launchpad" class="sidebar-link active">
                <span class="sidebar-icon">◎</span>
                Leaderboard
            </a>
            <a href="/dashboard" class="sidebar-link">
                <span class="sidebar-icon">◈</span>
                Dashboard
            </a>
            <a href="/guide" class="sidebar-link">
                <span class="sidebar-icon">◉</span>
                Guide
            </a>
            <a href="/roadmap" class="sidebar-link">
                <span class="sidebar-icon">◇</span>
                Roadmap
            </a>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">CULTURE COINS</div>
            <a href="/culture-coins" class="sidebar-link">
                <span class="sidebar-icon">◎</span>
                Discover
            </a>
            <span class="sidebar-link disabled">
                <span class="sidebar-icon">◈</span>
                Feed
                <span class="soon-tag">(soon)</span>
            </span>
            <span class="sidebar-link disabled">
                <span class="sidebar-icon">◇</span>
                Auctions
                <span class="soon-tag">(soon)</span>
            </span>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">CREATOR CENTRAL</div>
            <span class="sidebar-link disabled">
                <span class="sidebar-icon">◈</span>
                Create
                <span class="soon-tag">(soon)</span>
            </span>
            <span class="sidebar-link disabled">
                <span class="sidebar-icon">◉</span>
                My Cultures
                <span class="soon-tag">(soon)</span>
            </span>
        </div>
        <div class="sidebar-bottom">
            <div class="sidebar-label">RESOURCES</div>
            <a href="https://twitter.com/laaboratory" target="_blank" class="sidebar-link">
                <span class="sidebar-icon">𝕏</span>
                Twitter
            </a>
            <a href="https://t.me/launchr_sol" target="_blank" class="sidebar-link">
                <span class="sidebar-icon">◆</span>
                Telegram
            </a>
            <a href="https://t.me/LAUNCHR_V2_BOT" target="_blank" class="sidebar-link">
                <span class="sidebar-icon">◇</span>
                Telegram Bot
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeWalletModal()">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Wallet Connected</span>
                <button class="modal-close" onclick="closeWalletModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="wallet-info">
                    <div class="wallet-address" id="walletAddress">-</div>
                    <div class="wallet-balance" id="walletBalance">0.0000</div>
                    <div class="wallet-balance-label">SOL Balance</div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="copyWalletAddress()">Copy Address</button>
                    <button class="btn btn-primary" onclick="disconnectWallet()" style="background:var(--error);">Disconnect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Token Modal -->
    <div id="createModal" class="modal-overlay" style="display:none;" onclick="if(event.target===this)closeCreateModal()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <span class="modal-title">Launch New Token</span>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="create-form">
                    <div class="path-toggle" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                        <div class="path-option active" data-path="pump" onclick="selectPath('pump')">
                            <div class="path-option-header">
                                <span class="path-option-name">Pump.fun</span>
                                <span class="path-option-badge simple">Simple</span>
                            </div>
                            <div class="path-option-desc">One-click launch, auto bonding curve</div>
                        </div>
                        <div class="path-option" data-path="launchr" onclick="selectPath('launchr')">
                            <div class="path-option-header">
                                <span class="path-option-name">Mars Vanity</span>
                                <span class="path-option-badge advanced" style="background:var(--gold-dim);color:var(--gold);">Premium</span>
                            </div>
                            <div class="path-option-desc">Vanity address ending in <code style="color:var(--gold);">...Mars</code></div>
                        </div>
                        <div class="path-option" data-path="custom" onclick="selectPath('custom')">
                            <div class="path-option-header">
                                <span class="path-option-name">Custom Vanity</span>
                                <span class="path-option-badge" style="background:rgba(167,139,250,0.15);color:#a78bfa;">Pro</span>
                            </div>
                            <div class="path-option-desc">Choose your own address suffix</div>
                        </div>
                    </div>

                    <!-- Custom Vanity Input (hidden by default) -->
                    <div id="customVanitySection" style="display:none;margin-bottom:16px;">
                        <div class="form-group">
                            <label class="form-label">Custom Suffix <span style="color:var(--text-muted);font-weight:400;">(1-4 characters)</span></label>
                            <input type="text" class="form-input" id="customVanitySuffix" placeholder="e.g. DOGE, moon, etc..." maxlength="4" style="font-family:'JetBrains Mono',monospace;">
                            <p style="font-size:11px;color:var(--text-muted);margin-top:6px;">Address will end in your suffix. Shorter = faster generation.</p>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Token Name</label>
                            <input type="text" class="form-input" id="tokenName" placeholder="My Token">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Symbol</label>
                            <input type="text" class="form-input" id="tokenSymbol" placeholder="TICKER">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="tokenDesc" placeholder="A brief description of your token..." rows="2" style="resize:vertical;min-height:60px;"></textarea>
                    </div>

                    <!-- Image Uploads -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Token Icon <span style="color:var(--text-muted);font-weight:400;">(100x100, required)</span></label>
                            <div class="image-upload icon-upload" onclick="document.getElementById('tokenImage').click()">
                                <input type="file" id="tokenImage" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none;" onchange="previewImage(this, 'tokenImagePreview')">
                                <div id="tokenImagePreview" class="image-preview">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                    <span>100 x 100</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Banner <span style="color:var(--text-muted);font-weight:400;">(1500x500, optional)</span></label>
                            <div class="image-upload banner-upload" onclick="document.getElementById('tokenBanner').click()">
                                <input type="file" id="tokenBanner" accept="image/png,image/jpeg,image/gif,image/webp" style="display:none;" onchange="previewImage(this, 'tokenBannerPreview')">
                                <div id="tokenBannerPreview" class="image-preview">
                                    <svg width="48" height="16" viewBox="0 0 48 16" fill="none" stroke="currentColor" stroke-width="1"><rect x="0.5" y="0.5" width="47" height="15" rx="2"/></svg>
                                    <span>1500 x 500</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="form-group">
                        <label class="form-label">Social Links <span style="color:var(--text-muted);font-weight:400;">(for DexScreener)</span></label>
                        <div class="social-links-grid">
                            <div class="social-input">
                                <span class="social-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span>
                                <input type="text" class="form-input" id="tokenTwitter" placeholder="twitter.com/yourtoken">
                            </div>
                            <div class="social-input">
                                <span class="social-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg></span>
                                <input type="text" class="form-input" id="tokenTelegram" placeholder="t.me/yourgroup">
                            </div>
                            <div class="social-input">
                                <span class="social-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></span>
                                <input type="text" class="form-input" id="tokenWebsite" placeholder="yourtoken.com">
                            </div>
                            <div class="social-input">
                                <span class="social-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/></svg></span>
                                <input type="text" class="form-input" id="tokenDiscord" placeholder="discord.gg/invite">
                            </div>
                        </div>
                    </div>

                    <!-- Initial Dev Buy -->
                    <div class="form-group">
                        <label class="form-label">Initial Dev Buy <span style="color:var(--text-muted);font-weight:400;">(optional)</span></label>
                        <div class="dev-buy-input">
                            <input type="range" class="dev-buy-slider" id="devBuySlider" min="0" max="5" step="0.1" value="0" oninput="updateDevBuyDisplay()">
                            <div class="dev-buy-value">
                                <input type="number" class="form-input" id="devBuyAmount" value="0" min="0" max="5" step="0.1" style="width:80px;text-align:center;" onchange="syncDevBuySlider()">
                                <span>SOL</span>
                            </div>
                        </div>
                        <p class="dev-buy-hint">Buy tokens at launch to seed initial liquidity (0-5 SOL)</p>
                    </div>

                    <div class="form-hint" id="launchHint">
                        <span class="form-hint-icon">&#x1F680;</span>
                        <span id="launchHintText">Launch your token on <strong>Pump.fun</strong></span>
                    </div>

                    <button class="btn btn-primary" style="width:100%;padding:14px;" id="deployBtn" onclick="deployToken()">
                        Connect Wallet to Launch
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <main class="main">
        <!-- Scrolling Leaderboard Bar - RIGHT under nav -->
        <div class="trending-bar" id="trendingBar">
            <div class="trending-scroll-wrapper" id="trendingScrollWrapper">
                <div id="trendingTokens" style="display:flex;gap:20px;align-items:center;">
                    <!-- Rendered by JS -->
                </div>
                <div id="trendingTokensDupe" style="display:flex;gap:20px;align-items:center;">
                    <!-- Duplicate for seamless loop -->
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-inner">
                <div class="page-header-left">
                    <div class="page-title-group">
                        <h1 class="page-title">Launchpad</h1>
                        <p class="page-subtitle">Launch tokens. Track performance. 1% of creator fees go to the distribution pool.</p>
                    </div>
                </div>
                <div class="page-header-right">
                    <div class="timer-card">
                        <div class="timer-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        </div>
                        <div class="timer-content">
                            <div class="timer-label">Next Distribution</div>
                            <div class="timer-value" id="timer" style="font-size:18px;">Coming Soon</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stats-bar-inner">
                <div class="stat-cell clickable" onclick="scrollToTokens('all')">
                    <div class="stat-cell-value gold">0</div>
                    <div class="stat-cell-label">Total Launches</div>
                </div>
                <div class="stat-cell clickable" onclick="scrollToTokens('active')">
                    <div class="stat-cell-value gold">0</div>
                    <div class="stat-cell-label">Active Tokens</div>
                </div>
                <div class="stat-cell clickable" onclick="scrollToLeaderboard()">
                    <div class="stat-cell-value">$0</div>
                    <div class="stat-cell-label">24H Volume</div>
                </div>
                <div class="stat-cell clickable" onclick="scrollToLeaderboard()">
                    <div class="stat-cell-value teal">0</div>
                    <div class="stat-cell-label">Pool (SOL)</div>
                </div>
                <div class="stat-cell clickable" onclick="scrollToTokens('graduated')">
                    <div class="stat-cell-value success">0</div>
                    <div class="stat-cell-label">Graduated</div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content content-single">
            <!-- Token Table - Full Data View -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Discover Tokens</span>
                    <span class="card-badge live" style="margin-left:12px;">Live</span>
                    <button class="btn btn-primary btn-sm" style="margin-left:auto;" onclick="showCreateModal()">
                        Launch Token
                    </button>
                </div>
                <div class="token-list" id="tokenList">
                    <!-- Rendered by JS - Full token table -->
                </div>
            </div>

            <!-- Hidden leaderboard for scrolling bar data -->
            <div id="leaderboard" style="display:none;">
                <div id="leaderboardList"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-inner">
            <div class="footer-brand">
                <img src="/website/logo-icon.jpg" alt="LAUNCHR">
                <span>LAUNCHR Mission Control</span>
            </div>
            <div class="footer-links">
                <a href="/">Home</a>
                <a href="/launchpad">Launchpad</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/roadmap">Docs</a>
                <a href="/terms">Terms</a>
                <a href="https://t.me/LAUNCHR_V2_BOT" target="_blank">Telegram</a>
                <a href="https://x.com/LaunchrTG" target="_blank">Twitter</a>
            </div>
        </div>
    </footer>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // CONFIGURATION
        // ═══════════════════════════════════════════════════════════════════════
        const PRIVY_APP_ID = window.LAUNCHR_CONFIG?.PRIVY_APP_ID || '';
        const SOLANA_RPC = window.LAUNCHR_CONFIG?.SOLANA_RPC || 'https://api.mainnet-beta.solana.com';

        let privyClient = null;
        let connectedWallet = null;
        let walletBalance = 0;
        let selectedPath = 'pump';
        let tokens = [];
        let leaderboard = [];
        let liveTokens = { trending: [], new: [], graduating: [] };
        let currentTab = 'trending';
        let tokensLoaded = false; // Track if we've completed initial load

        // ═══════════════════════════════════════════════════════════════════════
        // COLUMN SORTING
        // ═══════════════════════════════════════════════════════════════════════
        let sortColumn = 'mcap'; // default sort by market cap
        let sortDirection = 'desc'; // desc = highest first

        function sortTokens(tokenArray, column, direction) {
            const sorted = [...tokenArray];
            const dir = direction === 'asc' ? 1 : -1;

            sorted.sort((a, b) => {
                let valA, valB;

                switch (column) {
                    case 'age':
                        valA = a.created || 0;
                        valB = b.created || 0;
                        break;
                    case 'mcap':
                        valA = a.mcap || 0;
                        valB = b.mcap || 0;
                        break;
                    case 'liquidity':
                        valA = a.liquidity || (a.realSolReserves || 0) / 1e9 * 200;
                        valB = b.liquidity || (b.realSolReserves || 0) / 1e9 * 200;
                        break;
                    case 'holders':
                        valA = a.holders || a.holder_count || 0;
                        valB = b.holders || b.holder_count || 0;
                        break;
                    case 'volume':
                        valA = a.volume24h || a.volume || 0;
                        valB = b.volume24h || b.volume || 0;
                        break;
                    case 'txns':
                        valA = (a.buys || 0) + (a.sells || 0);
                        valB = (b.buys || 0) + (b.sells || 0);
                        break;
                    case 'score':
                        valA = a.aiScore || 0;
                        valB = b.aiScore || 0;
                        break;
                    default:
                        valA = a.mcap || 0;
                        valB = b.mcap || 0;
                }

                return (valA - valB) * dir;
            });

            return sorted;
        }

        function handleSort(column) {
            if (sortColumn === column) {
                // Toggle direction
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                sortColumn = column;
                sortDirection = 'desc'; // default to descending for new column
            }
            renderLiveTokens();
        }

        function getSortIndicator(column) {
            if (sortColumn !== column) return '';
            return sortDirection === 'desc' ? ' ▼' : ' ▲';
        }

        // ═══════════════════════════════════════════════════════════════════════
        // TOKEN FILTER - Only allow pump.fun and LAUNCHR tokens
        // ═══════════════════════════════════════════════════════════════════════
        const BLOCKED_MINTS = [
            'Apfi3UpBUbunhfSBhgvE7gQzRo8eg5YfWECwcqFJpimp', // Pimpball - blocked
        ];

        function isAllowedToken(token) {
            // Block specific mints
            if (BLOCKED_MINTS.includes(token.mint)) return false;

            // Only allow tokens from pump.fun or LAUNCHR
            const path = (token.path || '').toLowerCase();
            if (path === 'pump' || path === 'launchr' || path === 'lchr' || path === 'pumpfun') {
                return true;
            }

            // For tokens without path, check if from our registered list or pump API
            if (token.isLaunchrToken) return true;

            // Default: allow (pump.fun tokens from API don't have path set)
            return true;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // THEME TOGGLE
        // ═══════════════════════════════════════════════════════════════════════
        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('launchr-theme', isLight ? 'light' : 'dark');
        }

        function initTheme() {
            const saved = localStorage.getItem('launchr-theme');
            if (saved === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await initPrivy();
            // Security: Don't auto-reconnect - require fresh login each time
            localStorage.removeItem('connectedWallet');

            // Load real data from API
            await Promise.all([
                fetchLiveTokens(),
                fetchLeaderboard(),
                fetchStats(),
                syncTimer(),
            ]);

            // Tab switching for live tokens
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderLiveTokens();
                });
            });

            // Auto-open launch modal if ?launch=true in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('launch') === 'true') {
                showCreateModal();
                // Clean up URL
                window.history.replaceState({}, '', '/launchpad');
            }

            // Auto-refresh data every 30 seconds
            setInterval(() => {
                fetchLiveTokens();
                fetchLeaderboard();
                fetchStats();
            }, 30000);
        });

        // ═══════════════════════════════════════════════════════════════════════
        // DATA FETCHING
        // ═══════════════════════════════════════════════════════════════════════

        // Fetch live tokens from Pump.fun API with retry logic
        let fetchAttempts = 0;
        const MAX_RETRIES = 5;
        const RETRY_DELAYS = [1000, 2000, 3000, 5000, 8000]; // Exponential-ish backoff

        async function fetchLiveTokens(isRetry = false) {
            if (!isRetry) {
                fetchAttempts = 0;
                tokensLoaded = false;
            }

            try {
                console.log(`[TOKENS] Fetching all tokens...`);
                updateLoadingState('loading');

                // FIRST: Get YOUR registered tokens from the platform
                let registeredTokens = [];
                try {
                    const regRes = await fetch('/api/tokens');
                    if (regRes.ok) {
                        const regData = await regRes.json();
                        registeredTokens = (regData.tokens || []).map(t => ({
                            mint: t.mint,
                            name: t.name || 'Unknown',
                            symbol: t.symbol || '???',
                            image: t.image,
                            mcap: t.mcap || 0,
                            volume: t.volume || 0,
                            price: t.price || 0,
                            complete: t.graduated,
                            created: t.createdAt ? Math.floor(t.createdAt / 1000) : null,
                            realSolReserves: (t.progress || 0) * 85 / 100 * 1e9,
                            isLaunchrToken: true,
                            // Socials from /api/tokens
                            twitter: t.twitter || null,
                            telegram: t.telegram || null,
                            website: t.website || null,
                            // Additional market data
                            liquidity: t.liquidity || 0,
                            priceChange24h: t.priceChange24h || 0,
                            holders: t.holders || t.holder_count || 0,
                            buys: t.buys || 0,
                            sells: t.sells || 0,
                            hasOrbit: t.hasOrbit || false,
                            allocations: t.allocations || null,
                            graduated: t.graduated || false
                        }));
                        console.log(`[TOKENS] Loaded ${registeredTokens.length} registered tokens`);
                    }
                } catch (e) {
                    console.log('[TOKENS] No registered tokens');
                }

                // SECOND: Get pump.fun tokens
                let pumpNewTokens = [];
                let pumpTrendingTokens = [];

                try {
                    const newRes = await fetch('/api/pump/coins?offset=0&limit=20&sort=created_timestamp&order=DESC');
                    if (newRes.ok) {
                        const data = await newRes.json();
                        pumpNewTokens = (data || []).map(t => ({
                            mint: t.mint,
                            name: t.name || 'Unknown',
                            symbol: t.symbol || '???',
                            image: t.image_uri,
                            mcap: t.usd_market_cap || 0,
                            volume: t.volume_24h || 0,
                            price: t.price || 0,
                            complete: t.complete,
                            created: t.created_timestamp,
                            realSolReserves: t.real_sol_reserves,
                            // Socials from Pump.fun API
                            twitter: t.twitter || null,
                            telegram: t.telegram || null,
                            website: t.website || null,
                            // Market data - holders and transactions
                            holders: t.holder_count || t.holders || 0,
                            buys: t.total_buys || t.buys || 0,
                            sells: t.total_sells || t.sells || 0,
                            hasOrbit: false
                        }));
                    }
                } catch (e) {}

                try {
                    const trendingRes = await fetch('/api/pump/coins?offset=0&limit=20&sort=usd_market_cap&order=DESC');
                    if (trendingRes.ok) {
                        const data = await trendingRes.json();
                        pumpTrendingTokens = (data || []).map(t => ({
                            mint: t.mint,
                            name: t.name || 'Unknown',
                            symbol: t.symbol || '???',
                            image: t.image_uri,
                            mcap: t.usd_market_cap || 0,
                            volume: t.volume_24h || 0,
                            price: t.price || 0,
                            complete: t.complete,
                            created: t.created_timestamp,
                            realSolReserves: t.real_sol_reserves,
                            // Socials from Pump.fun API
                            twitter: t.twitter || null,
                            telegram: t.telegram || null,
                            website: t.website || null,
                            // Market data - holders and transactions
                            holders: t.holder_count || t.holders || 0,
                            buys: t.total_buys || t.buys || 0,
                            sells: t.total_sells || t.sells || 0,
                            hasOrbit: false
                        }));
                    }
                } catch (e) {}

                // MERGE: Registered tokens FIRST, then pump.fun tokens
                const seenMints = new Set();

                // Add registered tokens first (prioritize YOUR tokens)
                liveTokens.new = [];
                liveTokens.trending = [];

                for (const t of registeredTokens) {
                    if (!seenMints.has(t.mint)) {
                        seenMints.add(t.mint);
                        liveTokens.new.push(t);
                        liveTokens.trending.push(t);
                    }
                }

                // Then add pump.fun tokens (with blocklist filter)
                for (const t of pumpNewTokens) {
                    if (!seenMints.has(t.mint) && isAllowedToken(t)) {
                        seenMints.add(t.mint);
                        liveTokens.new.push(t);
                    }
                }
                for (const t of pumpTrendingTokens) {
                    if (!seenMints.has(t.mint) && isAllowedToken(t)) {
                        seenMints.add(t.mint);
                        liveTokens.trending.push(t);
                    }
                }

                // Sort: new by creation time, trending by mcap
                liveTokens.new.sort((a, b) => (b.created || 0) - (a.created || 0));
                liveTokens.trending.sort((a, b) => (b.mcap || 0) - (a.mcap || 0));

                // Find graduating tokens
                const BONDING_CURVE_TARGET = 85;
                const allTokens = [...liveTokens.new, ...liveTokens.trending];
                liveTokens.graduating = allTokens
                    .filter(t => {
                        const solReserves = (t.realSolReserves || 0) / 1e9;
                        const progress = (solReserves / BONDING_CURVE_TARGET) * 100;
                        return progress >= 70 && !t.complete;
                    })
                    .sort((a, b) => (b.realSolReserves || 0) - (a.realSolReserves || 0))
                    .slice(0, 20);

                console.log(`[TOKENS] Total: ${liveTokens.new.length} new, ${liveTokens.trending.length} trending`);
                fetchAttempts = 0;
                tokensLoaded = true;
                renderLiveTokens();

                // Enrich tokens with holder data from individual endpoints
                enrichTokensWithHolders();
            } catch (e) {
                console.error('[TOKENS] Failed:', e);
                fetchAttempts++;
                if (fetchAttempts < MAX_RETRIES) {
                    const delay = RETRY_DELAYS[fetchAttempts - 1] || 5000;
                    updateLoadingState('retrying', fetchAttempts, MAX_RETRIES);
                    setTimeout(() => fetchLiveTokens(true), delay);
                } else {
                    updateLoadingState('error');
                    tokensLoaded = true;
                    renderLiveTokens();
                }
            }
        }

        function updateLoadingState(state, attempt = 0, max = 0) {
            const list = document.getElementById('tokenList');
            if (!list) return;

            if (state === 'loading') {
                list.innerHTML = `
                    <div style="padding:60px 20px;text-align:center;">
                        <div class="loading-spinner"></div>
                        <div style="color:var(--text-secondary);font-size:15px;margin-top:16px;">Loading tokens...</div>
                        <div style="color:var(--text-muted);font-size:13px;margin-top:4px;">Fetching from Pump.fun</div>
                    </div>
                `;
            } else if (state === 'retrying') {
                list.innerHTML = `
                    <div style="padding:60px 20px;text-align:center;">
                        <div class="loading-spinner"></div>
                        <div style="color:var(--gold);font-size:15px;margin-top:16px;">Retrying... (${attempt}/${max})</div>
                        <div style="color:var(--text-muted);font-size:13px;margin-top:4px;">Connection slow, please wait</div>
                    </div>
                `;
            } else if (state === 'error') {
                list.innerHTML = `
                    <div style="padding:60px 20px;text-align:center;">
                        <div style="font-size:40px;margin-bottom:16px;">⚠️</div>
                        <div style="color:var(--error);font-size:15px;margin-bottom:8px;">Failed to load tokens</div>
                        <button onclick="fetchLiveTokens()" style="padding:8px 16px;background:var(--gold);color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Enrich tokens with holder and transaction data from individual endpoints
        async function enrichTokensWithHolders() {
            // Collect all unique tokens
            const allTokens = [...new Map([
                ...liveTokens.new,
                ...liveTokens.trending,
                ...liveTokens.graduating
            ].map(t => [t.mint, t])).values()];

            console.log(`[ENRICH] Fetching holder data for ${allTokens.length} tokens...`);

            // Process in batches of 5
            for (let i = 0; i < allTokens.length; i += 5) {
                const batch = allTokens.slice(i, i + 5);

                await Promise.all(batch.map(async (token) => {
                    if (!token.mint) return;

                    let gotHolders = false;

                    // TRY 1: Pump.fun individual endpoint
                    try {
                        const res = await fetch(`/api/pump/coin/${token.mint}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data) {
                                if (data.holder_count > 0) {
                                    token.holders = data.holder_count;
                                    gotHolders = true;
                                    console.log(`[ENRICH] Pump.fun holders for ${token.symbol}: ${data.holder_count}`);
                                }
                                if (data.total_buys) token.buys = data.total_buys;
                                if (data.total_sells) token.sells = data.total_sells;
                            }
                        }
                    } catch (e) {}

                    // TRY 2: Jupiter API (for non-pump.fun tokens)
                    if (!gotHolders) {
                        try {
                            const res = await fetch(`https://lite-api.jup.ag/tokens/v2/search?query=${token.mint}`);
                            if (res.ok) {
                                const arr = await res.json();
                                const jupToken = Array.isArray(arr) ? arr.find(t => t.id === token.mint || t.address === token.mint) : null;
                                if (jupToken?.holderCount > 0) {
                                    token.holders = jupToken.holderCount;
                                    gotHolders = true;
                                    console.log(`[ENRICH] Jupiter holders for ${token.symbol}: ${jupToken.holderCount}`);
                                }
                            }
                        } catch (e) {}
                    }

                    // TRY 3: Solscan API
                    if (!gotHolders) {
                        try {
                            const res = await fetch(`https://public-api.solscan.io/token/meta?tokenAddress=${token.mint}`);
                            if (res.ok) {
                                const data = await res.json();
                                const holders = data.holder || data.holders || 0;
                                if (holders > 0) {
                                    token.holders = holders;
                                    gotHolders = true;
                                    console.log(`[ENRICH] Solscan holders for ${token.symbol}: ${holders}`);
                                }
                            }
                        } catch (e) {}
                    }

                    // Get txns from DexScreener if we don't have them
                    if (!token.buys && !token.sells) {
                        try {
                            const dexRes = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${token.mint}`);
                            if (dexRes.ok) {
                                const dexData = await dexRes.json();
                                const pair = dexData.pairs?.[0];
                                if (pair?.txns?.h24) {
                                    token.buys = pair.txns.h24.buys || 0;
                                    token.sells = pair.txns.h24.sells || 0;
                                    token.dex = { txns: pair.txns };
                                }
                                if (pair?.liquidity?.usd) {
                                    token.liquidity = pair.liquidity.usd;
                                }
                            }
                        } catch (e) {}
                    }
                }));

                // Re-render after each batch to show progress
                renderLiveTokens();

                // Small delay between batches to avoid rate limiting
                if (i + 5 < allTokens.length) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            console.log('[ENRICH] Holder data enrichment complete');
        }

        async function fetchTokens() {
            try {
                const res = await fetch('/api/tokens');
                const data = await res.json();
                tokens = data.tokens || [];
                renderTokens();
            } catch (e) {
                console.error('[API] Failed to fetch tokens:', e);
                renderTokens();
            }
        }

        async function fetchLeaderboard() {
            try {
                const res = await fetch('/api/leaderboard');
                const data = await res.json();
                leaderboard = data.leaderboard || [];
                renderLeaderboard();
            } catch (e) {
                console.error('[API] Failed to fetch leaderboard:', e);
                renderLeaderboard();
            }
        }

        async function fetchStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.querySelector('.stat-cell:nth-child(1) .stat-cell-value').textContent = stats.totalLaunches || 0;
                document.querySelector('.stat-cell:nth-child(2) .stat-cell-value').textContent = stats.vanityTokens || stats.totalLaunches || 0;
                document.querySelector('.stat-cell:nth-child(3) .stat-cell-value').textContent = formatVolume(stats.totalVolume || 0);
                document.querySelector('.stat-cell:nth-child(4) .stat-cell-value').textContent = (stats.poolDistribution || 0).toFixed(1);
                document.querySelector('.stat-cell:nth-child(5) .stat-cell-value').textContent = stats.graduated || 0;
            } catch (e) {
                console.error('[API] Failed to fetch stats:', e);
            }
        }

        async function syncTimer() {
            try {
                const res = await fetch('/api/timer');
                const data = await res.json();
                startTimer(data.secondsRemaining || 21600); // 6 hour default
            } catch (e) {
                startTimer(21600); // 6 hours = 21600 seconds
            }
        }

        function formatVolume(vol) {
            if (vol >= 1000000) return '$' + (vol / 1000000).toFixed(1) + 'M';
            if (vol >= 1000) return '$' + (vol / 1000).toFixed(1) + 'K';
            return '$' + vol;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENDER FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════

        // Render live tokens from Pump.fun based on current tab - FULL TABLE FORMAT
        function renderLiveTokens() {
            const list = document.getElementById('tokenList');
            const unsortedTokens = liveTokens[currentTab] || [];
            const currentTokens = sortTokens(unsortedTokens, sortColumn, sortDirection);

            if (currentTokens.length === 0) {
                const loadingMessages = {
                    trending: 'Loading trending tokens...',
                    new: 'Loading new tokens...',
                    graduating: 'Loading graduating tokens...'
                };
                const emptyMessages = {
                    trending: 'No trending tokens found',
                    new: 'No new tokens found',
                    graduating: 'No tokens graduating yet'
                };
                const message = tokensLoaded ? emptyMessages[currentTab] : loadingMessages[currentTab];
                const subMessage = tokensLoaded ? 'Check back soon for new launches' : 'Fetching from Pump.fun...';

                list.innerHTML = `
                    <div style="padding:60px 20px;text-align:center;">
                        <div style="font-size:40px;margin-bottom:16px;opacity:0.3;">&#x1F680;</div>
                        <div style="color:var(--text-secondary);font-size:15px;margin-bottom:8px;">${message}</div>
                        <div style="color:var(--text-muted);font-size:13px;">${subMessage}</div>
                        ${tokensLoaded ? '<button onclick="fetchLiveTokens()" style="margin-top:16px;padding:8px 16px;background:var(--gold);color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Refresh</button>' : '<div class="loading-spinner" style="margin-top:16px;"></div>'}
                    </div>
                `;
                return;
            }

            const BONDING_CURVE_TARGET = 85;

            // Full data table with LAUNCHR gold color scheme - sortable columns
            const sortableStyle = 'cursor:pointer;user-select:none;transition:color 0.2s;';
            const activeStyle = 'color:var(--gold);';
            const tableHeader = `
                <div style="display:grid;grid-template-columns:50px 180px 70px 95px 80px 65px 75px 85px 70px 70px 90px 50px 50px 50px 50px;gap:8px;padding:12px 16px;background:var(--bg-elevated);font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;">
                    <div onclick="handleSort('age')" style="${sortableStyle}${sortColumn === 'age' ? activeStyle : ''}" title="Sort by age">Age${getSortIndicator('age')}</div>
                    <div>Token</div>
                    <div>Socials</div>
                    <div onclick="handleSort('mcap')" style="${sortableStyle}${sortColumn === 'mcap' ? activeStyle : ''}" title="Sort by market cap">Market Cap${getSortIndicator('mcap')}</div>
                    <div onclick="handleSort('liquidity')" style="${sortableStyle}${sortColumn === 'liquidity' ? activeStyle : ''}" title="Sort by liquidity">Liquidity${getSortIndicator('liquidity')}</div>
                    <div onclick="handleSort('holders')" style="${sortableStyle}${sortColumn === 'holders' ? activeStyle : ''}" title="Sort by holders">Holders${getSortIndicator('holders')}</div>
                    <div onclick="handleSort('volume')" style="${sortableStyle}${sortColumn === 'volume' ? activeStyle : ''}" title="Sort by volume">Volume${getSortIndicator('volume')}</div>
                    <div onclick="handleSort('txns')" style="text-align:center;${sortableStyle}${sortColumn === 'txns' ? activeStyle : ''}" title="Sort by transactions">Txns${getSortIndicator('txns')}</div>
                    <div onclick="handleSort('score')" style="${sortableStyle}${sortColumn === 'score' ? activeStyle : ''}" title="Sort by score">Score${getSortIndicator('score')}</div>
                    <div>Signal</div>
                    <div style="text-align:center;">Action</div>
                    <div style="text-align:center;color:#f5a623;" title="Burn %"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-3.866 0-7-3.134-7-7 0-2.577 1.409-4.83 3.5-6.03C8.5 9.97 8.5 10 8.5 10c0-3.038 2.462-5.5 5.5-5.5 0 0-.5 2.5 1 4.5s3 2.5 3 5.5c0 3.866-3.134 7-7 7z"/></svg></div>
                    <div style="text-align:center;color:#00d4aa;" title="AI-Driven AMM %">AMM</div>
                    <div style="text-align:center;color:#a855f7;" title="Creator Fees %">Fees</div>
                    <div style="text-align:center;color:#ec4899;" title="Liquidity %">LP</div>
                </div>
            `;

            const tableRows = currentTokens.map(t => {
                const solInCurve = (t.realSolReserves || 0) / 1e9;
                const timeAgo = t.created ? getTimeAgo(t.created) : 'now';
                const mcapUsd = t.mcap || 0;
                const priceChange = t.priceChange24h || 0;
                const buys = t.buys || t.dex?.txns?.h24?.buys || 0;
                const sells = t.sells || t.dex?.txns?.h24?.sells || 0;
                const holders = t.holders || t.holder_count || 0;
                const totalTxns = buys + sells;
                const liquidity = t.liquidity || solInCurve * 200;
                const volume = t.volume24h || t.volume || t.dex?.volume?.h24 || 0;

                // Use API score (capped at 89) or proportional fallback
                // Scales properly - bigger metrics = higher score, no flat caps
                const score = t.aiScore ? Math.min(89, t.aiScore) : Math.min(89, Math.floor(
                    Math.min(20, mcapUsd / 5000) +                    // 0-20 pts (scales to $100K)
                    Math.min(15, volume / 4000) +                     // 0-15 pts (scales to $60K)
                    Math.min(15, holders / 40) +                      // 0-15 pts (scales to 600)
                    Math.min(15, totalTxns / 80) +                    // 0-15 pts (scales to 1200)
                    Math.min(10, (buys / Math.max(1, sells)) * 4) +   // 0-10 pts (buy/sell ratio)
                    Math.min(14, liquidity / 3000)                    // 0-14 pts (scales to $42K)
                ));

                // Signal based on score - gold theme
                let signal, signalColor;
                if (score >= 70) { signal = '↑ Strong'; signalColor = 'var(--gold)'; }
                else if (score >= 50) { signal = '→ Hold'; signalColor = 'var(--text-secondary)'; }
                else if (score >= 30) { signal = '↓ Weak'; signalColor = 'var(--text-muted)'; }
                else { signal = '⚠ Low'; signalColor = 'var(--text-muted)'; }

                // Socials
                const hasSocials = t.twitter || t.telegram || t.website;

                // Get allocation percentages - only show if TEK/ORBIT is active
                // If no ORBIT, 100% goes to creator. Uses engine field names.
                const alloc = t.hasOrbit ? (t.allocations || { buybackBurn: 25, marketMaking: 25, creatorRevenue: 25, liquidity: 25 }) : null;

                return `
                <div onclick="openPumpToken('${escapeHtml(t.mint)}')" style="display:grid;grid-template-columns:50px 180px 70px 95px 80px 65px 75px 85px 70px 70px 90px 50px 50px 50px 50px;gap:8px;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;align-items:center;font-size:13px;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
                    <!-- AGE -->
                    <div style="color:var(--text-muted);font-size:12px;">${timeAgo}</div>

                    <!-- TOKEN -->
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;border-radius:8px;background:var(--surface-2);background-size:cover;background-position:center;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--gold);font-size:12px;${t.image ? `background-image:url('${escapeHtml(t.image)}')` : ''}">
                            ${!t.image ? escapeHtml((t.symbol || '?')[0]) : ''}
                        </div>
                        <div style="min-width:0;">
                            <div style="font-weight:600;color:var(--text-primary);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                                ${escapeHtml(t.name || 'Unknown')}${t.hasOrbit ? '<span class="tek-icon" title="Token Engine Kit Active"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 3V7M12 17V21M3 12H7M17 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>' : ''}${t.graduated ? '<span style="color:#5fa663;font-size:9px;margin-left:4px;font-weight:600;">GRAD</span>' : ''}${hasSocials ? '<span style="color:var(--gold);margin-left:4px;">✓</span>' : ''}
                            </div>
                            <div style="font-size:11px;color:var(--text-muted);">$${escapeHtml(t.symbol || '???')}</div>
                        </div>
                    </div>

                    <!-- SOCIALS -->
                    <div onclick="event.stopPropagation()" style="display:flex;gap:6px;">
                        ${t.twitter ? `<a href="${escapeHtml(t.twitter)}" target="_blank" style="color:var(--text-secondary);font-size:14px;text-decoration:none;" title="Twitter">𝕏</a>` : '<span style="color:var(--surface-3);">𝕏</span>'}
                        ${t.website ? `<a href="${escapeHtml(t.website)}" target="_blank" style="color:var(--text-secondary);font-size:14px;text-decoration:none;" title="Website">🌐</a>` : ''}
                    </div>

                    <!-- MARKET CAP -->
                    <div>
                        <div style="font-weight:600;color:var(--text-primary);">${mcapUsd > 0 ? '$' + formatNumber(mcapUsd) : '-'}</div>
                        ${priceChange !== 0 ? `<div style="font-size:10px;color:${priceChange >= 0 ? 'var(--success)' : 'var(--danger)'};">${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(1)}%</div>` : ''}
                    </div>

                    <!-- LIQUIDITY -->
                    <div style="color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${liquidity > 0 ? '$' + formatNumber(liquidity) : '-'}</div>

                    <!-- HOLDERS -->
                    <div style="color:#fff;font-family:'JetBrains Mono',monospace;text-align:right;">${holders > 0 ? holders.toLocaleString() : '-'}</div>

                    <!-- VOLUME -->
                    <div style="color:#fff;font-family:'JetBrains Mono',monospace;text-align:right;">${volume > 0 ? '$' + formatNumber(volume) : '-'}</div>

                    <!-- TXNS (with buys/sells breakdown) -->
                    <div style="text-align:center;">
                        ${totalTxns > 0 ? `
                            <div style="font-weight:600;color:#fff;font-size:13px;">${totalTxns.toLocaleString()}</div>
                            <div style="font-size:11px;margin-top:2px;">
                                <span style="color:#00ff88;">${buys.toLocaleString()}</span>
                                <span style="color:var(--text-muted);margin:0 2px;">/</span>
                                <span style="color:#ff4757;">${sells.toLocaleString()}</span>
                            </div>
                        ` : '-'}
                    </div>

                    <!-- SCORE -->
                    <div>
                        <span style="background:${score >= 70 ? 'rgba(255,217,102,0.15)' : score >= 50 ? 'rgba(255,255,255,0.08)' : 'rgba(255,255,255,0.04)'};color:${score >= 70 ? 'var(--gold)' : 'var(--text-secondary)'};padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;">${score}</span>
                    </div>

                    <!-- SIGNAL -->
                    <div style="color:${signalColor};font-size:11px;font-weight:500;">${signal}</div>

                    <!-- ACTION -->
                    <div onclick="event.stopPropagation()" style="text-align:center;">
                        <button onclick="window.open('https://pump.fun/coin/${escapeHtml(t.mint)}','_blank')" style="padding:6px 12px;background:var(--gold);color:#000;border:none;border-radius:5px;font-size:10px;font-weight:700;cursor:pointer;">VIEW</button>
                    </div>

                    <!-- BURN % (buybackBurn) -->
                    <div style="text-align:center;color:#f5a623;font-size:11px;font-weight:600;">${alloc ? alloc.buybackBurn + '%' : '-'}</div>

                    <!-- AMM % (marketMaking) -->
                    <div style="text-align:center;color:#00d4aa;font-size:11px;font-weight:600;">${alloc ? alloc.marketMaking + '%' : '-'}</div>

                    <!-- CREATOR FEES % (creatorRevenue) -->
                    <div style="text-align:center;color:#a855f7;font-size:11px;font-weight:600;">${alloc ? alloc.creatorRevenue + '%' : '100%'}</div>

                    <!-- LIQUIDITY % -->
                    <div style="text-align:center;color:#ec4899;font-size:11px;font-weight:600;">${alloc ? alloc.liquidity + '%' : '-'}</div>
                </div>
                `;
            }).join('');

            list.innerHTML = tableHeader + tableRows;
        }

        // Open token on Pump.fun
        function openPumpToken(mint) {
            if (!isValidSolanaAddress(mint)) {
                console.error('[SECURITY] Invalid token address blocked');
                return;
            }
            window.open('https://pump.fun/coin/' + encodeURIComponent(mint), '_blank', 'noopener,noreferrer');
        }

        // Get human-readable time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() / 1000) - timestamp);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        function renderTokens() {
            const list = document.getElementById('tokenList');
            if (tokens.length === 0) {
                list.innerHTML = `
                    <div style="padding:60px 20px;text-align:center;">
                        <div style="font-size:40px;margin-bottom:16px;opacity:0.3;">&#x1F680;</div>
                        <div style="color:var(--text-secondary);font-size:15px;margin-bottom:8px;">No tokens launched yet</div>
                        <div style="color:var(--text-muted);font-size:13px;">Be the first to launch on LAUNCHR</div>
                        <button class="btn btn-primary" style="margin-top:20px;" onclick="showCreateModal()">Launch First Token</button>
                    </div>
                `;
                return;
            }
            // Sanitize ALL token data before rendering
            list.innerHTML = tokens.map(rawToken => {
                const t = sanitizeToken(rawToken);
                if (!t.mint) return ''; // Skip invalid tokens
                const changeClass = t.change >= 0 ? 'positive' : 'negative';
                const changeText = t.change !== 0 ? (t.change >= 0 ? '+' : '') + t.change.toFixed(1) + '%' : '-';
                const graduatedBadge = t.graduated === true ? '<span style="color:var(--success);font-size:10px;margin-left:6px;">GRADUATED</span>' : '';
                const tekBadge = t.hasOrbit === true ? '<span class="tek-icon" title="Token Engine Kit Active"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 3V7M12 17V21M3 12H7M17 12H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>' : '';
                const progressBar = t.graduated !== true && t.progress > 0 ? `<div style="margin-top:6px;"><div style="background:var(--surface-3);height:4px;border-radius:2px;overflow:hidden;"><div style="background:linear-gradient(90deg, var(--gold), var(--success));height:100%;width:${Math.min(t.progress, 100).toFixed(1)}%;"></div></div><div style="font-size:9px;color:var(--text-muted);margin-top:2px;">${t.progress.toFixed(1)}% to graduation</div></div>` : '';
                return `
                <div class="token-item" onclick="openTokenLink('${t.mint}')" role="button" tabindex="0">
                    <div class="token-avatar" style="background-size:cover;background-position:center;${t.image ? `background-image:url('${escapeHtml(t.image)}')` : ''}">
                        ${!t.image ? t.name.charAt(0) : ''}
                    </div>
                    <div class="token-details">
                        <div class="token-name">${t.name}${tekBadge}${graduatedBadge}</div>
                        <div class="token-meta">
                            <span class="token-ticker">$${t.symbol}</span>
                            <span class="token-path ${t.path}">${t.path === 'launchr' ? 'Mars' : 'Pump.fun'}</span>
                            <span class="token-time">${t.time}</span>
                        </div>
                        ${progressBar}
                    </div>
                    <div class="token-stats">
                        <div class="token-mcap">${t.mcap > 0 ? '$' + formatNumber(t.mcap) : '-'}</div>
                        <div class="token-volume">${t.volume > 0 ? 'Vol: $' + formatNumber(t.volume) : ''}</div>
                    </div>
                    <div class="token-change">
                        <div class="token-change-value ${changeClass}">${changeText}</div>
                        <div class="token-change-label">24h</div>
                    </div>
                </div>`;
            }).filter(Boolean).join('');
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            const trendingBar = document.getElementById('trendingTokens');
            const trendingBarDupe = document.getElementById('trendingTokensDupe');

            if (leaderboard.length === 0) {
                list.innerHTML = `
                    <div style="padding:40px 20px;text-align:center;">
                        <div style="color:var(--text-secondary);font-size:14px;margin-bottom:6px;">No competition data</div>
                        <div style="color:var(--text-muted);font-size:12px;">Launch tokens to join the leaderboard</div>
                    </div>
                `;
                if (trendingBar) trendingBar.innerHTML = '<span style="color:var(--text-muted);font-size:12px;">No trending tokens</span>';
                if (trendingBarDupe) trendingBarDupe.innerHTML = '';
                return;
            }

            // HORIZONTAL TRENDING BAR (top of page) - Scrolling marquee
            if (trendingBar) {
                const trendingHtml = leaderboard.slice(0, 10).map(rawEntry => {
                    const l = sanitizeLeaderEntry(rawEntry);
                    const change = l.change || 0;
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const changeText = change !== 0 ? `${change >= 0 ? '+' : ''}${change.toFixed(1)}%` : '';

                    return `
                    <div class="trending-token" onclick="window.open('https://pump.fun/coin/${escapeHtml(l.mint)}','_blank')">
                        <span style="color:var(--gold);font-weight:700;font-size:11px;">#${l.rank}</span>
                        <div style="width:24px;height:24px;border-radius:50%;background:var(--surface-3);background-size:cover;background-position:center;flex-shrink:0;${l.image ? `background-image:url('${escapeHtml(l.image)}')` : 'display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:bold;color:var(--gold);'}">
                            ${!l.image ? escapeHtml(l.symbol?.charAt(0) || '?') : ''}
                        </div>
                        <div>
                            <div class="trending-token-name">$${escapeHtml(l.symbol)}</div>
                            <div style="font-size:10px;color:var(--text-muted);">$${formatNumber(l.mcap)}</div>
                        </div>
                        ${changeText ? `<span class="trending-token-change ${changeClass}">${changeText}</span>` : ''}
                    </div>`;
                }).join('');

                trendingBar.innerHTML = trendingHtml;
                // Duplicate for seamless infinite scroll
                if (trendingBarDupe) trendingBarDupe.innerHTML = trendingHtml;
            }

            // VERTICAL SIDEBAR LEADERBOARD (keep for reference)
            list.innerHTML = leaderboard.map(rawEntry => {
                const l = sanitizeLeaderEntry(rawEntry);
                const rankClass = l.rank <= 3 ? `rank-${l.rank}` : '';
                const graduatedBadge = l.graduated === true ? '<span style="color:var(--success);font-size:9px;margin-left:4px;">&#x2713;</span>' : '';
                return `
                <div class="leader-item">
                    <div class="leader-rank ${rankClass}">${l.rank}</div>
                    <div class="leader-avatar" style="width:32px;height:32px;border-radius:50%;background:var(--surface-3);margin-right:10px;overflow:hidden;flex-shrink:0;${l.image ? `background-image:url('${l.image}');background-size:cover;background-position:center;` : 'display:flex;align-items:center;justify-content:center;font-weight:600;color:var(--gold);font-size:12px;'}">${!l.image ? l.name.charAt(0) : ''}</div>
                    <div class="leader-info" style="flex:1;min-width:0;">
                        <div class="leader-name">${l.name}${graduatedBadge}</div>
                        <div class="leader-meta">
                            <span class="leader-ticker">$${l.symbol}</span>
                            <span class="leader-path">${l.path}</span>
                        </div>
                    </div>
                    <div class="leader-mcap">$${formatNumber(l.mcap)}</div>
                    ${l.reward ? `<div class="leader-reward">${l.reward}</div>` : '<div style="width:60px"></div>'}
                </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SECURITY UTILITIES - CIA-LEVEL PROTECTION
        // ═══════════════════════════════════════════════════════════════════════
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"'`]/g, m => ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'
            })[m] || m);
        }

        // Validate Solana address format (base58, 32-44 chars)
        function isValidSolanaAddress(address) {
            if (!address || typeof address !== 'string') return false;
            const base58Regex = /^[1-9A-HJ-NP-Za-km-z]{32,44}$/;
            return base58Regex.test(address);
        }

        // Sanitize CSS class names (only allow alphanumeric, dash, underscore)
        function sanitizeClassName(name) {
            if (!name || typeof name !== 'string') return '';
            return name.replace(/[^a-zA-Z0-9_-]/g, '');
        }

        // Secure external link opener with validation
        function openTokenLink(mint) {
            if (!isValidSolanaAddress(mint)) {
                console.error('[SECURITY] Invalid token address blocked');
                return;
            }
            // Use encodeURIComponent for extra safety
            const safeUrl = 'https://solscan.io/token/' + encodeURIComponent(mint);
            window.open(safeUrl, '_blank', 'noopener,noreferrer');
        }

        // Secure number formatting (prevents injection via numbers)
        function formatNumber(num) {
            const n = parseFloat(num);
            if (isNaN(n) || !isFinite(n)) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return Math.floor(n).toString();
        }

        // Validate and sanitize token data before rendering
        function sanitizeToken(t) {
            return {
                mint: isValidSolanaAddress(t.mint) ? t.mint : '',
                name: escapeHtml(String(t.name || 'Unknown').slice(0, 50)),
                symbol: escapeHtml(String(t.symbol || 'TOKEN').slice(0, 10)),
                image: t.image && typeof t.image === 'string' ? escapeHtml(t.image.slice(0, 500)) : null,
                path: ['pump', 'launchr'].includes(t.path) ? t.path : 'pump',
                mcap: Math.max(0, parseFloat(t.mcap) || 0),
                volume: Math.max(0, parseFloat(t.volume) || 0),
                price: Math.max(0, parseFloat(t.price) || 0),
                change: parseFloat(t.change) || 0,
                progress: Math.min(100, Math.max(0, parseFloat(t.progress) || 0)),
                graduated: Boolean(t.graduated),
                time: escapeHtml(String(t.time || 'New').slice(0, 20)),
            };
        }

        // Validate leaderboard entry
        function sanitizeLeaderEntry(l) {
            return {
                mint: isValidSolanaAddress(l.mint) ? l.mint : '', // CRITICAL: needed for pump.fun link
                rank: Math.min(Math.max(1, parseInt(l.rank) || 99), 99),
                name: escapeHtml(String(l.name || 'Unknown').slice(0, 50)),
                symbol: escapeHtml(String(l.symbol || 'TOKEN').slice(0, 10)),
                image: l.image && typeof l.image === 'string' ? escapeHtml(l.image.slice(0, 500)) : null,
                mcap: Math.max(0, parseFloat(l.mcap) || 0),
                volume: Math.max(0, parseFloat(l.volume) || 0),
                progress: Math.min(100, Math.max(0, parseFloat(l.progress) || 0)),
                graduated: Boolean(l.graduated),
                path: escapeHtml(String(l.path || 'Pump.fun').slice(0, 20)),
                reward: l.reward ? escapeHtml(String(l.reward).slice(0, 20)) : null,
                change: parseFloat(l.change) || 0,
            };
        }

        // ═══════════════════════════════════════════════════════════════════════
        // TIMER (disabled - showing "Coming Soon" instead)
        // ═══════════════════════════════════════════════════════════════════════
        function startTimer(initialSeconds) {
            // Timer disabled - holder rewards coming soon
            return;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PATH SELECTION
        // ═══════════════════════════════════════════════════════════════════════
        function selectPath(path) {
            selectedPath = path;
            document.querySelectorAll('.path-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.path === path);
            });
            // Show/hide custom vanity input
            const customSection = document.getElementById('customVanitySection');
            if (customSection) {
                customSection.style.display = path === 'custom' ? 'block' : 'none';
            }
            // Update hint text based on path
            const hintText = document.getElementById('launchHintText');
            if (path === 'launchr') {
                hintText.innerHTML = 'Launch with <strong style="color:var(--gold);">Mars vanity address</strong> on Pump.fun';
            } else if (path === 'custom') {
                hintText.innerHTML = 'Launch with <strong style="color:#a78bfa;">your custom suffix</strong> (generated in-browser)';
            } else {
                hintText.innerHTML = 'Launch your token on <strong>Pump.fun</strong>';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODALS
        // ═══════════════════════════════════════════════════════════════════════
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
            updateDeployBtn();
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        function updateDeployBtn() {
            const btn = document.getElementById('deployBtn');
            btn.textContent = connectedWallet ? 'Launch Token' : 'Connect Wallet to Launch';
        }

        // ═══════════════════════════════════════════════════════════════════════
        // TOKEN DEPLOYMENT - REAL PUMPPORTAL INTEGRATION
        // ═══════════════════════════════════════════════════════════════════════

        // Upload token metadata to Pump.fun IPFS
        async function uploadTokenMetadata(name, symbol, description, imageFile, socials = {}) {
            const formData = new FormData();

            // Add image if provided, otherwise require it
            if (imageFile) {
                formData.append('file', imageFile);
            } else {
                throw new Error('Token icon is required');
            }

            formData.append('name', name);
            formData.append('symbol', symbol);
            formData.append('description', description || `${name} ($${symbol}) - Launched via LAUNCHR`);
            formData.append('twitter', socials.twitter || '');
            formData.append('telegram', socials.telegram || '');
            formData.append('website', socials.website || '');
            formData.append('showName', 'true');

            console.log('[DEPLOY] Uploading metadata to IPFS...');

            const response = await fetch('/api/ipfs-upload', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`IPFS upload failed: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('[DEPLOY] IPFS upload successful:', data);

            return {
                metadataUri: data.metadataUri,
                imageUrl: data.imageUrl || data.metadata?.image || null,
                metadata: data.metadata || { name, symbol, description }
            };
        }

        // Generate mint keypair based on selected path
        // VAULT: Returns { publicKey, vaultId } for vanity, or { keypair } for random/custom
        async function generateMintKeypair() {
            const { Keypair, PublicKey } = solanaWeb3;

            // Mars Vanity path - must get vanity keypair from vault
            if (selectedPath === 'launchr') {
                try {
                    const res = await fetch('/api/vanity-keypair');
                    if (res.ok) {
                        const data = await res.json();
                        if (data.success && data.vaultId) {
                            console.log('[DEPLOY] Got Mars vanity mint:', data.publicKey, '(vault secured)');
                            return {
                                publicKey: new PublicKey(data.publicKey),
                                vaultId: data.vaultId,
                                isVanity: true
                            };
                        }
                    }
                    // No vanity available - check status
                    const statusRes = await fetch('/api/vanity-status');
                    const status = statusRes.ok ? await statusRes.json() : {};
                    const msg = status.isGenerating
                        ? `No Mars addresses available. Mining in progress (${status.stats?.found || 0} found so far). Try again soon!`
                        : 'No Mars addresses available. Please try again later or use Pump.fun path.';
                    throw new Error(msg);
                } catch (e) {
                    throw new Error(e.message || 'Mars vanity keypair unavailable');
                }
            }

            // Custom Vanity path - use server API with vault (same as Mars vanity)
            if (selectedPath === 'custom') {
                const suffixInput = document.getElementById('customVanitySuffix');
                const suffix = suffixInput?.value?.trim();
                if (!suffix || suffix.length < 1) {
                    throw new Error('Please enter a custom suffix (1-4 characters)');
                }
                if (suffix.length > 4) {
                    throw new Error('Suffix must be 4 characters or less');
                }
                // Validate suffix contains only valid base58 characters
                const validChars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
                for (const char of suffix) {
                    if (!validChars.includes(char)) {
                        throw new Error(`Invalid character "${char}" in suffix. Use only alphanumeric (no 0, O, I, l)`);
                    }
                }

                console.log('[DEPLOY] Requesting custom vanity from server with suffix:', suffix);

                // Update button to show mining status
                const btn = document.getElementById('deployBtn');
                if (btn) btn.textContent = 'Mining custom vanity...';

                try {
                    const res = await fetch('/api/custom-vanity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ suffix })
                    });

                    const data = await res.json();

                    if (!res.ok || !data.success) {
                        throw new Error(data.error || 'Failed to generate custom vanity');
                    }

                    console.log(`[DEPLOY] Got custom vanity mint: ${data.publicKey} (vault secured, ${data.attempts.toLocaleString()} attempts in ${data.duration}s)`);
                    return {
                        publicKey: new PublicKey(data.publicKey),
                        vaultId: data.vaultId,
                        isVanity: true
                    };
                } catch (e) {
                    throw new Error(e.message || 'Custom vanity generation failed');
                }
            }

            // Standard Pump.fun path - use random keypair (local signing)
            const mintKeypair = Keypair.generate();
            console.log('[DEPLOY] Generated random mint address:', mintKeypair.publicKey.toString());
            return {
                publicKey: mintKeypair.publicKey,
                keypair: mintKeypair,
                isVanity: false
            };
        }

        // Create token via PumpPortal API
        // mintInfo: { publicKey, vaultId?, keypair?, isVanity }
        async function createTokenViaPumpPortal(walletAddress, mintInfo, tokenMetadata, initialBuySOL = 0) {
            const { VersionedTransaction, Connection } = solanaWeb3;

            const connection = new Connection(SOLANA_RPC, 'confirmed');

            const requestBody = {
                publicKey: walletAddress,
                action: 'create',
                tokenMetadata: {
                    name: tokenMetadata.metadata.name,
                    symbol: tokenMetadata.metadata.symbol,
                    uri: tokenMetadata.metadataUri
                },
                mint: mintInfo.publicKey.toString(),
                denominatedInSol: 'true',
                amount: initialBuySOL,
                slippage: 10,
                priorityFee: 0.0005,
                pool: 'pump'
            };

            console.log('[DEPLOY] Creating token via PumpPortal:', requestBody);

            const response = await fetch('https://pumpportal.fun/api/trade-local', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (response.status !== 200) {
                const errorText = await response.text();
                throw new Error(`PumpPortal API error: ${response.status} - ${errorText}`);
            }

            // PumpPortal returns raw binary transaction data
            const txBuffer = await response.arrayBuffer();
            console.log('[DEPLOY] Received transaction buffer, size:', txBuffer.byteLength);

            // Deserialize the versioned transaction
            const tx = VersionedTransaction.deserialize(new Uint8Array(txBuffer));
            console.log('[DEPLOY] Transaction deserialized successfully');

            return { transaction: tx, connection, mintInfo };
        }

        // Sign and send transaction using connected wallet
        // mintInfo: { publicKey, vaultId?, keypair?, isVanity }
        // For vanity (Mars/Custom): wallet signs first, then server adds mint sig and sends
        // For pump.fun: local mint keypair signs, then wallet signs, then client sends
        async function signAndSendTransaction(tx, connection, mintInfo) {
            console.log('[DEPLOY] Signing transaction...');

            let signature;

            // VANITY PATH (Mars or Custom): Wallet signs first, server adds mint sig and sends
            // This matches TG bot pattern: tx.sign([walletKeypair, mintKeypair]) then sendRawTransaction
            if (mintInfo.isVanity && mintInfo.vaultId) {
                console.log('[DEPLOY] Vanity path: wallet signs first, then server adds mint sig and sends');

                // Ensure wallet is still connected
                if (window.solana?.isPhantom) {
                    if (!window.solana.isConnected) {
                        console.log('[DEPLOY] Reconnecting Phantom wallet...');
                        await window.solana.connect();
                    }
                    console.log('[DEPLOY] Phantom connected, publicKey:', window.solana.publicKey?.toString());
                }

                // Step 1: Wallet signs the UNSIGNED transaction
                let walletSignedTx;
                try {
                    if (window.solana?.isPhantom) {
                        console.log('[DEPLOY] Requesting Phantom signature...');
                        walletSignedTx = await window.solana.signTransaction(tx);
                    } else if (window.solflare?.isSolflare) {
                        console.log('[DEPLOY] Requesting Solflare signature...');
                        walletSignedTx = await window.solflare.signTransaction(tx);
                    } else if (privyClient) {
                        console.log('[DEPLOY] Requesting Privy signature...');
                        const user = await privyClient.getUser();
                        if (user?.wallet?.address) {
                            walletSignedTx = await privyClient.signTransaction(tx);
                        } else {
                            throw new Error('No Privy wallet connected');
                        }
                    } else {
                        throw new Error('No compatible wallet found');
                    }
                } catch (walletErr) {
                    console.error('[DEPLOY] Wallet signing error:', walletErr);
                    if (walletErr.message?.includes('User rejected')) {
                        throw new Error('Transaction cancelled by user');
                    }
                    throw new Error('Wallet signing failed: ' + walletErr.message);
                }

                console.log('[DEPLOY] Wallet signed successfully, sending to vault for mint signature...');

                // Step 2: Send wallet-signed tx to server, server adds mint sig and sends
                const txBytes = walletSignedTx.serialize();
                const txBase64 = btoa(String.fromCharCode(...txBytes));

                const vaultRes = await fetch('/api/vault/sign-and-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vaultId: mintInfo.vaultId,
                        transaction: txBase64
                    })
                });

                const vaultData = await vaultRes.json();
                if (!vaultRes.ok || !vaultData.success) {
                    throw new Error(vaultData.error || 'Vault sign-and-send failed');
                }

                signature = vaultData.signature;
                console.log('[DEPLOY] Server sent transaction:', signature);
            }
            // PUMP.FUN PATH: Local mint keypair, wallet signs, client sends
            else if (mintInfo.keypair) {
                console.log('[DEPLOY] Pump.fun path: local mint keypair signing...');
                tx.sign([mintInfo.keypair]);

                // Pre-simulate for non-vanity transactions
                console.log('[DEPLOY] Pre-simulating transaction...');
                try {
                    const simulation = await connection.simulateTransaction(tx, {
                        sigVerify: false,
                        replaceRecentBlockhash: true
                    });
                    if (simulation.value.err) {
                        console.error('[DEPLOY] Simulation error:', JSON.stringify(simulation.value.err));
                        const errStr = JSON.stringify(simulation.value.err);
                        if (errStr.includes('InsufficientFunds')) {
                            throw new Error('Insufficient SOL in wallet for transaction fees');
                        }
                        throw new Error('Transaction simulation failed: ' + (simulation.value.logs?.slice(-2).join(' | ') || errStr));
                    }
                    console.log('[DEPLOY] Pre-simulation successful');
                } catch (simErr) {
                    if (simErr.message.includes('simulation failed') || simErr.message.includes('Insufficient')) {
                        throw simErr;
                    }
                    console.warn('[DEPLOY] Pre-simulation check failed:', simErr.message);
                }

                // Wallet signs and sends
                if (window.solana?.isPhantom) {
                    console.log('[DEPLOY] Using Phantom wallet for signing...');
                    const signedTx = await window.solana.signTransaction(tx);
                    signature = await connection.sendRawTransaction(signedTx.serialize(), {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed',
                        maxRetries: 3
                    });
                } else if (window.solflare?.isSolflare) {
                    console.log('[DEPLOY] Using Solflare wallet for signing...');
                    const signedTx = await window.solflare.signTransaction(tx);
                    signature = await connection.sendRawTransaction(signedTx.serialize(), {
                        skipPreflight: false,
                        preflightCommitment: 'confirmed',
                        maxRetries: 3
                    });
                } else if (privyClient) {
                    console.log('[DEPLOY] Using Privy wallet for signing...');
                    const user = await privyClient.getUser();
                    if (user?.wallet?.address) {
                        const signedTx = await privyClient.signTransaction(tx);
                        signature = await connection.sendRawTransaction(signedTx.serialize(), {
                            skipPreflight: false,
                            preflightCommitment: 'confirmed',
                            maxRetries: 3
                        });
                    } else {
                        throw new Error('No Privy wallet connected');
                    }
                } else {
                    throw new Error('No compatible wallet found');
                }
            } else {
                throw new Error('No signing method available for mint keypair');
            }

            console.log('[DEPLOY] Transaction sent, signature:', signature);

            // Wait for confirmation (skip for vanity - server already confirmed)
            if (!mintInfo.isVanity) {
                console.log('[DEPLOY] Waiting for confirmation...');
                const confirmation = await connection.confirmTransaction(signature, 'confirmed');

                if (confirmation.value.err) {
                    throw new Error('Transaction failed: ' + JSON.stringify(confirmation.value.err));
                }
            }

            console.log('[DEPLOY] Transaction confirmed!');
            return signature;
        }

        // Image preview helper
        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            const uploadDiv = input.closest('.image-upload');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    uploadDiv.classList.add('has-image');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Dev buy slider helpers
        function updateDevBuyDisplay() {
            const slider = document.getElementById('devBuySlider');
            const input = document.getElementById('devBuyAmount');
            input.value = slider.value;
        }

        function syncDevBuySlider() {
            const slider = document.getElementById('devBuySlider');
            const input = document.getElementById('devBuyAmount');
            let val = parseFloat(input.value) || 0;
            if (val < 0) val = 0;
            if (val > 5) val = 5;
            input.value = val;
            slider.value = val;
        }

        // Main deploy function
        async function deployToken() {
            if (!connectedWallet) {
                connectWallet();
                return;
            }

            const name = document.getElementById('tokenName').value.trim();
            const symbol = document.getElementById('tokenSymbol').value.trim();
            const description = document.getElementById('tokenDesc').value.trim();

            // Get image file
            const imageInput = document.getElementById('tokenImage');
            const imageFile = imageInput.files && imageInput.files[0] ? imageInput.files[0] : null;

            // Get social links
            const socials = {
                twitter: document.getElementById('tokenTwitter').value.trim(),
                telegram: document.getElementById('tokenTelegram').value.trim(),
                website: document.getElementById('tokenWebsite').value.trim(),
                discord: document.getElementById('tokenDiscord').value.trim()
            };

            // Get initial dev buy amount
            const devBuyAmount = parseFloat(document.getElementById('devBuyAmount').value) || 0;

            if (!name || !symbol) {
                showNotification('Please enter token name and symbol', 'error');
                return;
            }

            if (symbol.length > 10) {
                showNotification('Symbol must be 10 characters or less', 'error');
                return;
            }

            if (!imageFile) {
                showNotification('Please upload a token icon', 'error');
                return;
            }

            // Update button state
            const btn = document.getElementById('deployBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Uploading metadata...';
            btn.style.opacity = '0.7';

            try {
                // Step 1: Upload metadata to IPFS
                const tokenMetadata = await uploadTokenMetadata(name, symbol, description, imageFile, socials);

                btn.textContent = selectedPath === 'launchr' ? 'Getting Mars address...' : (selectedPath === 'custom' ? 'Mining custom vanity...' : 'Generating mint...');

                // Step 2: Generate mint info (tries vanity vault first)
                const mintInfo = await generateMintKeypair();

                btn.textContent = 'Creating token...';

                // Step 3: Create token via PumpPortal
                const { transaction, connection } = await createTokenViaPumpPortal(
                    connectedWallet,
                    mintInfo,
                    tokenMetadata,
                    devBuyAmount // Initial dev buy amount in SOL
                );

                btn.textContent = mintInfo.isVanity ? 'Signing via vault...' : 'Waiting for signature...';

                // Step 4: Sign and send transaction (vault for vanity, local for random)
                const signature = await signAndSendTransaction(transaction, connection, mintInfo);

                btn.textContent = 'Token launched!';

                // Success! Show result
                const mintAddress = mintInfo.publicKey.toString();
                console.log('[DEPLOY] Token created successfully!');
                console.log('[DEPLOY] Mint address:', mintAddress);
                console.log('[DEPLOY] Transaction:', signature);

                showNotification(`Token ${symbol} launched successfully!`, 'success');

                // Show success modal with token details
                showLaunchSuccess(name, symbol, mintAddress, signature);

                // Register token in tracker so it shows on dashboard
                await registerTokenAfterLaunch(mintAddress, name, symbol, tokenMetadata.imageUrl || tokenMetadata.metadataUri);

                // Close create modal
                closeCreateModal();

                // Refresh token list
                setTimeout(() => fetchTokens(), 2000);

            } catch (error) {
                console.error('[DEPLOY] Error:', error);

                // Better error messages
                let errorMsg = error.message || 'Token launch failed';

                // Handle specific errors with better UX
                if (errorMsg.includes('insufficient') || errorMsg.includes('SOL')) {
                    errorMsg = 'Insufficient SOL. Add more SOL to your wallet and try again.';
                } else if (errorMsg.includes('Buffer') || errorMsg.includes('serialize')) {
                    errorMsg = 'Network issue. Refreshing... Please try again in 15 seconds.';
                    // Auto-retry after 15 seconds
                    setTimeout(() => {
                        btn.textContent = 'Ready to retry';
                        btn.disabled = false;
                    }, 15000);
                } else if (errorMsg.includes('User rejected')) {
                    errorMsg = 'Transaction cancelled by user';
                } else {
                    errorMsg = errorMsg + ' - Please try again';
                }

                showNotification(errorMsg, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.opacity = '1';
            }
        }

        // Register token after successful launch
        async function registerTokenAfterLaunch(mint, name, symbol, imageUri) {
            if (!connectedWallet) return;

            try {
                const res = await fetch('/api/register-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mint,
                        creator: connectedWallet,
                        name,
                        symbol,
                        image: imageUri,
                        path: selectedPath
                    })
                });
                const data = await res.json();
                if (data.success) {
                    console.log('[REGISTER] Token registered:', mint);
                }
            } catch (e) {
                console.error('[REGISTER] Failed to register token:', e);
            }
        }

        // Show notification toast
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'error' ? 'var(--error)' : type === 'success' ? 'var(--success)' : 'var(--surface-3)'};
                color: ${type === 'error' || type === 'success' ? '#000' : 'var(--text)'};
                border-radius: var(--radius);
                font-size: 14px;
                font-weight: 500;
                z-index: 3000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Add animation keyframes if not exists
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            // Auto remove after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        }

        // Show launch success modal
        function showLaunchSuccess(name, symbol, mintAddress, signature) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'successModal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--success-dim), var(--surface));">
                        <span class="modal-title" style="color: var(--success);">Token Launched!</span>
                        <button class="modal-close" onclick="document.getElementById('successModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align:center;">
                        <div style="font-size:48px;margin-bottom:16px;color:var(--success);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <h3 style="font-size:24px;margin-bottom:8px;">${escapeHtml(name)}</h3>
                        <div style="color:var(--gold);font-size:18px;margin-bottom:20px;">$${escapeHtml(symbol)}</div>

                        <div style="background:var(--bg);padding:16px;border-radius:var(--radius);margin-bottom:16px;">
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">MINT ADDRESS</div>
                            <div style="font-family:'JetBrains Mono',monospace;font-size:12px;word-break:break-all;color:var(--text);">${escapeHtml(mintAddress)}</div>
                        </div>

                        <div class="modal-actions" style="flex-direction:column;gap:10px;">
                            <a href="https://pump.fun/coin/${encodeURIComponent(mintAddress)}" target="_blank" rel="noopener noreferrer"
                               class="btn btn-primary" style="width:100%;">
                                View on Pump.fun
                            </a>
                            <a href="https://solscan.io/tx/${encodeURIComponent(signature)}" target="_blank" rel="noopener noreferrer"
                               class="btn btn-secondary" style="width:100%;">
                                View Transaction
                            </a>
                            <button class="btn btn-ghost" style="width:100%;" onclick="navigator.clipboard.writeText('${mintAddress}');this.textContent='Copied!';">
                                Copy Mint Address
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // WALLET FUNCTIONS
        // ═══════════════════════════════════════════════════════════════════════
        async function initPrivy() {
            if (!PRIVY_APP_ID) {
                console.log('[PRIVY] App ID not configured - Privy disabled');
                return;
            }

            // Listen for messages from Privy auth popup via BroadcastChannel (more reliable across tabs)
            const channel = new BroadcastChannel('launchr-auth');
            channel.onmessage = (e) => {
                if (e.data?.type === 'privy-auth-success' && e.data?.address) {
                    console.log('[PRIVY] Received wallet from BroadcastChannel:', e.data.address);
                    handleWalletConnected(e.data.address);
                    showNotification('Connected with Privy wallet!', 'success');
                }
            };

            // Also listen via window.opener.postMessage (fallback for popups)
            window.addEventListener('message', (e) => {
                if (e.data?.type === 'privy-auth-success' && e.data?.address) {
                    console.log('[PRIVY] Received wallet from postMessage:', e.data.address);
                    handleWalletConnected(e.data.address);
                    showNotification('Connected with Privy wallet!', 'success');
                }
            });

            console.log('[PRIVY] Ready - listening via BroadcastChannel + postMessage');
        }

        async function connectWallet() {
            if (connectedWallet) { showWalletModal(); return; }
            showWalletSelectModal();
        }

        function showWalletSelectModal() {
            // Check which wallets are available
            const hasPhantom = window.solana?.isPhantom;
            const hasSolflare = window.solflare?.isSolflare;
            const hasPrivy = !!PRIVY_APP_ID;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'walletSelectModal';
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            modal.innerHTML = `
                <div class="modal" style="max-width:380px;">
                    <div class="modal-header">
                        <span class="modal-title">Connect Wallet</span>
                        <button class="modal-close" onclick="document.getElementById('walletSelectModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="padding:20px;">
                        <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;text-align:center;">
                            Choose your wallet to connect
                        </p>
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            ${hasPrivy ? '<button class="wallet-option recommended" onclick="connectPrivy()"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="#8B5CF6"/><path d="M12 6L18 10V14L12 18L6 14V10L12 6Z" fill="white"/></svg><span>Privy</span><span class="wallet-detected">Email / Social Login</span></button>' : ''}
                            <button class="wallet-option ${hasPhantom ? '' : 'disabled'}" onclick="${hasPhantom ? 'connectPhantom()' : ''}" ${hasPhantom ? '' : 'disabled'}>
                                <img src="/website/phantom_icon.png" alt="Phantom" style="width:28px;height:28px;border-radius:6px;">
                                <span>Phantom</span>
                                ${hasPhantom ? '<span class="wallet-detected">Detected</span>' : '<span class="wallet-not-detected">Not installed</span>'}
                            </button>
                            <button class="wallet-option ${hasSolflare ? '' : 'disabled'}" onclick="${hasSolflare ? 'connectSolflare()' : ''}" ${hasSolflare ? '' : 'disabled'}>
                                <img src="https://solflare.com/favicon.ico" alt="Solflare" style="width:28px;height:28px;border-radius:6px;">
                                <span>Solflare</span>
                                ${hasSolflare ? '<span class="wallet-detected">Detected</span>' : '<span class="wallet-not-detected">Not installed</span>'}
                            </button>
                        </div>
                        ${!hasPhantom && !hasSolflare && !hasPrivy ? '<p style="margin-top:16px;color:var(--text-muted);font-size:12px;text-align:center;">No wallet detected. Install <a href="https://phantom.app" target="_blank" style="color:var(--gold);">Phantom</a> to connect.</p>' : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add wallet option styles if not exists
            if (!document.getElementById('wallet-select-styles')) {
                const style = document.createElement('style');
                style.id = 'wallet-select-styles';
                style.textContent = `
                    .wallet-option {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 14px 16px;
                        background: var(--bg);
                        border: 1px solid var(--border);
                        border-radius: var(--radius);
                        cursor: pointer;
                        transition: all 0.15s;
                        font-size: 15px;
                        font-weight: 500;
                        color: var(--text);
                    }
                    .wallet-option:hover:not(.disabled) {
                        border-color: var(--gold);
                        background: var(--gold-dim);
                    }
                    .wallet-option.disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    .wallet-option span:first-of-type {
                        flex: 1;
                        text-align: left;
                    }
                    .wallet-detected {
                        font-size: 11px;
                        color: var(--success);
                        background: var(--success-dim);
                        padding: 3px 8px;
                        border-radius: 10px;
                    }
                    .wallet-not-detected {
                        font-size: 11px;
                        color: var(--text-muted);
                    }
                    .wallet-option.recommended {
                        border-color: var(--gold);
                        background: var(--gold-dim);
                    }
                `;
                document.head.appendChild(style);
            }
        }

        async function connectPrivy() {
            document.getElementById('walletSelectModal')?.remove();

            if (!PRIVY_APP_ID) {
                showNotification('Privy not configured', 'error');
                return;
            }

            // Open as centered popup for better UX (stays on same page feel)
            const w = 420, h = 650;
            const left = (screen.width - w) / 2;
            const top = (screen.height - h) / 2;
            window.open('/auth', 'privy-auth', `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`);
        }

        async function connectPhantom() {
            document.getElementById('walletSelectModal')?.remove();
            try {
                const res = await window.solana.connect();
                handleWalletConnected(res.publicKey.toString());
            } catch (e) {
                console.error('[PHANTOM]', e);
                showNotification('Failed to connect Phantom', 'error');
            }
        }

        async function connectSolflare() {
            document.getElementById('walletSelectModal')?.remove();
            try {
                await window.solflare.connect();
                handleWalletConnected(window.solflare.publicKey.toString());
            } catch (e) {
                console.error('[SOLFLARE]', e);
                showNotification('Failed to connect Solflare', 'error');
            }
        }

        async function handleWalletConnected(address) {
            connectedWallet = address;
            const btn = document.getElementById('connectWallet');
            btn.textContent = address.slice(0, 4) + '...' + address.slice(-4);
            btn.classList.add('wallet-connected');
            await fetchBalance(address);
            // Security: Don't persist wallet - session only
            updateDeployBtn();
        }

        async function fetchBalance(address) {
            try {
                const res = await fetch(SOLANA_RPC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jsonrpc: '2.0', id: 1, method: 'getBalance', params: [address] }),
                });
                const data = await res.json();
                if (data.result?.value !== undefined) {
                    walletBalance = data.result.value / 1e9;
                    document.getElementById('walletBalance').textContent = walletBalance.toFixed(4);
                }
            } catch (e) { console.error('[BALANCE]', e); }
        }

        async function disconnectWallet() {
            if (privyClient) try { await privyClient.logout(); } catch (e) {}
            if (window.solana?.isPhantom) try { await window.solana.disconnect(); } catch (e) {}
            connectedWallet = null;
            walletBalance = 0;
            localStorage.removeItem('connectedWallet');
            document.getElementById('connectWallet').textContent = 'Connect Wallet';
            document.getElementById('connectWallet').classList.remove('wallet-connected');
            closeWalletModal();
            updateDeployBtn();
        }

        function showWalletModal() {
            if (!connectedWallet) return;
            document.getElementById('walletAddress').textContent = connectedWallet;
            document.getElementById('walletBalance').textContent = walletBalance.toFixed(4);
            document.getElementById('walletModal').style.display = 'flex';
        }

        function closeWalletModal() {
            document.getElementById('walletModal').style.display = 'none';
        }

        function copyWalletAddress() {
            navigator.clipboard.writeText(connectedWallet);
        }

        // Smooth scroll to leaderboard with visual feedback
        function scrollToLeaderboard(event) {
            if (event) event.preventDefault();
            const leaderboard = document.getElementById('leaderboard');
            if (leaderboard) {
                // Add highlight effect
                leaderboard.style.transition = 'box-shadow 0.3s ease';
                leaderboard.style.boxShadow = '0 0 30px rgba(255,217,102,0.5)';

                // Scroll smoothly
                leaderboard.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Remove highlight after animation
                setTimeout(() => {
                    leaderboard.style.boxShadow = '';
                }, 2000);
            }
        }

        // Scroll to token list with optional filter
        function scrollToTokens(filter) {
            const tokenList = document.getElementById('tokenList');
            if (tokenList) {
                // Add highlight effect
                tokenList.style.transition = 'box-shadow 0.3s ease';
                tokenList.style.boxShadow = '0 0 30px rgba(255,217,102,0.5)';

                // Scroll smoothly
                tokenList.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Remove highlight after animation
                setTimeout(() => {
                    tokenList.style.boxShadow = '';
                }, 2000);

                // TODO: Add filter functionality when filter dropdown exists
                console.log('[TOKENS] Scrolled to tokens with filter:', filter);
            }
        }
    </script>

    </div><!-- End main-content -->
</body>
</html>
